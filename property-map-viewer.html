<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚ªãƒ‘ãƒ¬ã‚¹ç‰©ä»¶ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆã‚µãƒ¼ãƒãƒ¼ä¸è¦ç‰ˆï¼‰</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }



        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
        }

        button {
            padding: 12px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #0056b3;
        }

        .button-secondary {
            background: #28a745;
        }

        .button-secondary:hover {
            background: #1e7e34;
        }

        .button-danger {
            background: #dc3545;
        }

        .button-danger:hover {
            background: #c82333;
        }

        .search-results,
        .saved-properties {
            margin-top: 20px;
        }

        .property-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: between;
            align-items: center;
            transition: box-shadow 0.3s;
        }

        .property-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .property-info {
            flex: 1;
        }

        .property-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .property-address {
            color: #666;
            font-size: 14px;
        }

        .property-id {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }

        .property-actions {
            display: flex;
            gap: 10px;
        }

        .saved-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }



        .map-link {
            display: inline-block;
            background: #fd7e14;
            color: white;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 5px;
            font-size: 18px;
            margin-top: 15px;
            transition: background 0.3s;
        }

        .map-link:hover {
            background: #e8590c;
        }

        .map-link-small {
            display: inline-block;
            background: #fd7e14;
            color: white;
            padding: 4px 8px;
            text-decoration: none;
            border-radius: 3px;
            font-size: 12px;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .map-link-small:hover {
            background: #e8590c;
            text-decoration: none;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .subsection {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .subsection-title {
            font-size: 16px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-align: center;
        }

        .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .filter-section label {
            font-weight: bold;
            margin-right: 5px;
        }

        select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .town-group {
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .town-group:hover {
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
            transform: translateY(-2px);
        }

        .town-group.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
            z-index: 1000;
        }

        .town-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            cursor: grab;
        }

        .town-header:active {
            cursor: grabbing;
        }

        .town-header::before {
            content: "â‹®â‹®";
            color: rgba(255, 255, 255, 0.7);
            font-weight: bold;
            margin-right: 8px;
            line-height: 1;
        }

        .town-name {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .town-map-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .town-map-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .town-map-btn:active {
            cursor: pointer;
        }

        .town-properties {
            background: white;
        }

        .town-properties .property-item {
            border: none;
            border-bottom: 1px solid #f0f0f0;
            border-radius: 0;
            margin-bottom: 0;
        }

        .town-properties .property-item:last-child {
            border-bottom: none;
        }

        .town-properties .property-item:hover {
            background: #f8f9fa;
        }

        .town-stats {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 5px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #1565c0;
        }

        .town-stats-details {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .route-optimization {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .route-optimization-header {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .route-options {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .route-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .route-option input[type="radio"] {
            margin: 0;
        }

        .route-option label {
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }

        .destination-option {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 12px;
            margin: 10px 0;
        }

        .destination-option-header {
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .destination-choice {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }

        .destination-choice input[type="checkbox"] {
            margin: 0;
        }

        .destination-choice label {
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        .custom-destination {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 6px;
            font-size: 13px;
            color: #555;
            margin-top: 5px;
        }

        .manual-sort {
            margin-top: 15px;
        }

        .sortable-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .sortable-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .sortable-item:hover {
            background: #f8f9fa;
        }

        .sortable-item.dragging {
            opacity: 0.5;
        }

        .drag-handle {
            color: #999;
            font-size: 18px;
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .mobile-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-left: 10px;
        }

        .mobile-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mobile-btn:hover {
            background: #0056b3;
        }

        .mobile-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .touch-handle {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
            color: #666;
            font-size: 12px;
            margin: 5px 0;
            user-select: none;
        }

        .touch-handle.active {
            background: #e3f2fd;
            border-color: #007bff;
            color: #007bff;
        }

        /* åœ°åŸŸåˆ¥ã‚½ãƒ¼ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .region-sortable-container {
            margin: 15px 0;
        }

        .region-group-sortable {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
        }

        .region-group-sortable:hover {
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
            transform: translateY(-2px);
        }

        .region-group-sortable.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
            z-index: 1000;
        }

        .region-header-sortable {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: grab;
        }

        .region-header-sortable:active {
            cursor: grabbing;
        }

        .region-drag-handle {
            color: rgba(255, 255, 255, 0.7);
            font-weight: bold;
            margin-right: 8px;
            line-height: 1;
        }

        .region-mobile-controls {
            display: flex;
            gap: 5px;
        }

        .region-properties-list {
            background: #f8f9fa;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .region-property-item {
            padding: 8px 15px;
            border-bottom: 1px solid #e9ecef;
            background: white;
        }

        .region-property-item:last-child {
            border-bottom: none;
        }

        .region-property-item:hover {
            background: #f8f9fa;
        }

        .region-select-container {
            background: #f0f8f0;
            border: 1px solid #c3e6c3;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .region-select-header {
            font-weight: bold;
            color: #155724;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .region-select-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .region-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .region-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
        }

        .region-checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        .region-checkbox-item label {
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        .region-select-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .region-selection-message {
            min-height: 20px;
        }

        @media (max-width: 768px) {
            .sortable-item {
                flex-direction: column;
                align-items: stretch;
            }

            .drag-handle {
                display: none;
            }

            .property-info-mobile {
                margin-bottom: 10px;
            }

            .route-options {
                flex-direction: column;
                gap: 8px;
            }

            .route-option {
                justify-content: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¢ ãƒ¬ã‚ªãƒ‘ãƒ¬ã‚¹ç‰©ä»¶ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆã‚µãƒ¼ãƒãƒ¼ä¸è¦ç‰ˆï¼‰</h1>

        <!-- ç‰©ä»¶ç®¡ç†ãƒ»æ¤œç´¢ãƒ»ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºçµ±åˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="saved-section">
            <div class="section-title">ğŸ¢ ãƒ¬ã‚ªãƒ‘ãƒ¬ã‚¹ç‰©ä»¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>

            <!-- æ¤œç´¢ã‚¨ãƒªã‚¢ -->
            <div class="subsection">
                <div class="subsection-title">ğŸ” ç‰©ä»¶æ¤œç´¢</div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ç‰©ä»¶åã€ä½æ‰€ã€ç‰©ä»¶IDã§æ¤œç´¢...">
                    <button onclick="searchProperties()">æ¤œç´¢</button>
                    <button onclick="loadAllProperties()" class="button-secondary">å…¨ä»¶è¡¨ç¤º</button>
                </div>

                <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="filter-section">
                    <label for="prefectureFilter">éƒ½é“åºœçœŒ:</label>
                    <select id="prefectureFilter" onchange="filterByPrefecture()">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                    <label for="cityFilter">å¸‚åŒºç”ºæ‘:</label>
                    <select id="cityFilter" onchange="filterByCity()">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>

                <!-- çµ±è¨ˆæƒ…å ± -->
                <div class="stats">
                    <div class="stat-item">
                        <div>ç·ç‰©ä»¶æ•°</div>
                        <div id="totalProperties">0</div>
                    </div>
                    <div class="stat-item">
                        <div>æ¤œç´¢çµæœ</div>
                        <div id="searchResultCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div>ä¿å­˜æ¸ˆã¿</div>
                        <div id="savedCount">0</div>
                    </div>
                </div>

                <div id="searchResults" class="search-results"></div>
            </div>

            <!-- ä¿å­˜æ¸ˆã¿ç‰©ä»¶ãƒ»ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="subsection">
                <div class="subsection-title">ğŸ’¾ ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã¨ãƒ«ãƒ¼ãƒˆè¡¨ç¤º</div>
                <div style="margin-bottom: 15px;">
                    <button onclick="clearAllSaved()" class="button-danger">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
                    <button onclick="exportSavedProperties()" class="button-secondary">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
                <div id="savedProperties" class="saved-properties"></div>
                <div id="mapLinkContainer"></div>
            </div>
        </div>
    </div>

    <!-- å¤–éƒ¨JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚µãƒ¼ãƒãƒ¼ä¸è¦ï¼‰ -->
    <script src="./leopalace-data.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let allProperties = []; // å…¨ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿
        let currentSearchResults = []; // ç¾åœ¨ã®æ¤œç´¢çµæœ
        let savedProperties = []; // ä¿å­˜æ¸ˆã¿ç‰©ä»¶ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰

        /**
         * ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–å‡¦ç†
         * å¤–éƒ¨JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹
         */
        window.onload = async function () {
            try {
                showMessage('ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');
                await loadJavaScriptData();
                loadSavedProperties();
                updateStats();
                updateSavedPropertiesDisplay();
                updateMapLink();
                populateLocationFilters();
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒãƒ¼ä¸è¦ç‰ˆï¼‰', 'success');
            } catch (error) {
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        };

        /**
         * å¤–éƒ¨JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ï¼ˆã‚µãƒ¼ãƒãƒ¼ä¸è¦ï¼‰
         * å¤–éƒ¨JSãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨å‰å‡¦ç†ã‚’è¡Œã†
         */
        async function loadJavaScriptData() {
            try {
                // å¤–éƒ¨JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                if (typeof window.LEOPALACE_DATA === 'undefined') {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆleopalace-data.jsï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                const data = window.LEOPALACE_DATA;

                // allPropertiesãŒé…åˆ—ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
                if (data.allProperties && Array.isArray(data.allProperties)) {
                    allProperties = data.allProperties;
                } else {
                    throw new Error('JavaScriptãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                }

                console.log(`${allProperties.length}ä»¶ã®ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒãƒ¼ä¸è¦ç‰ˆï¼‰`);
            } catch (error) {
                console.error('JavaScriptãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        /**
         * ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
         * ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ã‚‚è¡Œã†
         */
        function loadSavedProperties() {
            try {
                const stored = localStorage.getItem('savedProperties');
                if (stored) {
                    savedProperties = JSON.parse(stored);
                    // ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
                    if (!Array.isArray(savedProperties)) {
                        savedProperties = [];
                    }
                }
            } catch (error) {
                console.error('ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                savedProperties = [];
            }
        }

        /**
         * ç‰©ä»¶ã‚’æ¤œç´¢ã™ã‚‹é–¢æ•°
         * ç‰©ä»¶åã€ä½æ‰€ã€ç‰©ä»¶IDã§éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹
         */
        function searchProperties() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();

            if (!searchTerm) {
                showMessage('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // æ¤œç´¢å®Ÿè¡Œ
            currentSearchResults = allProperties.filter(property => {
                return (
                    (property.propertyName && property.propertyName.toLowerCase().includes(searchTerm)) ||
                    (property.address && property.address.toLowerCase().includes(searchTerm)) ||
                    (property.propertyId && property.propertyId.toLowerCase().includes(searchTerm))
                );
            });

            displaySearchResults();
            updateStats();

            if (currentSearchResults.length === 0) {
                showMessage(`ã€Œ${searchTerm}ã€ã«ä¸€è‡´ã™ã‚‹ç‰©ä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`, 'error');
            } else {
                showMessage(`${currentSearchResults.length}ä»¶ã®ç‰©ä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`, 'success');
            }
        }

        /**
         * å…¨ç‰©ä»¶ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         */
        function loadAllProperties() {
            currentSearchResults = [...allProperties];
            displaySearchResults();
            updateStats();
            showMessage(`å…¨${allProperties.length}ä»¶ã®ç‰©ä»¶ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`, 'success');
        }

        /**
 * ä½æ‰€ã‹ã‚‰ç”ºåã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
 * @param {string} address - ä½æ‰€æ–‡å­—åˆ—
 * @returns {string} æŠ½å‡ºã•ã‚ŒãŸç”ºå
 */
        function extractTownName(address) {
            if (!address) return 'ä½æ‰€ä¸æ˜';

            // ä½æ‰€ã‹ã‚‰å¸‚åŒºç”ºæ‘ã‚’æŠ½å‡ºï¼ˆä¾‹: "åƒè‘‰çœŒé‡ç”°å¸‚ä¸­é‡Œï¼—âˆ’ï¼‘" â†’ "é‡ç”°å¸‚"ï¼‰
            const cityMatch = address.match(/[éƒ½é“åºœçœŒ](.*?[å¸‚åŒºç”ºæ‘])/);
            if (cityMatch) {
                return cityMatch[1];
            }

            // æ±äº¬23åŒºã®å ´åˆï¼ˆä¾‹: "æ±äº¬éƒ½æ¸‹è°·åŒº..." â†’ "æ¸‹è°·åŒº"ï¼‰
            const tokyoMatch = address.match(/æ±äº¬éƒ½(.*?åŒº)/);
            if (tokyoMatch) {
                return tokyoMatch[1];
            }

            // ãã®ä»–ã®å ´åˆã¯æœ€åˆã®éƒ¨åˆ†ã‚’è¿”ã™
            const parts = address.split(/[éƒ½é“åºœçœŒ]/);
            if (parts.length > 1) {
                const afterPrefecture = parts[1];
                const townPart = afterPrefecture.split(/[ç”ºä¸ç›®ç•ªåœ°]/)[0];
                return townPart || 'ä½æ‰€ä¸æ˜';
            }

            return 'ä½æ‰€ä¸æ˜';
        }

        /**
         * æ¤œç´¢çµæœã‚’ç”ºåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹é–¢æ•°
         * @param {Array} properties - ç‰©ä»¶é…åˆ—
         * @returns {Object} ç”ºåã‚’ã‚­ãƒ¼ã¨ã—ãŸã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function groupPropertiesByTown(properties) {
            const grouped = {};

            properties.forEach(property => {
                const townName = extractTownName(property.address);

                if (!grouped[townName]) {
                    grouped[townName] = [];
                }
                grouped[townName].push(property);
            });

            return grouped;
        }

        /**
         * æ¤œç´¢çµæœã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
         * ç”ºåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤ºã™ã‚‹
         */
        function displaySearchResults() {
            const resultsContainer = document.getElementById('searchResults');

            if (currentSearchResults.length === 0) {
                resultsContainer.innerHTML = '<p class="loading">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // æœ€å¤§è¡¨ç¤ºä»¶æ•°ã‚’åˆ¶é™ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
            const maxDisplay = 100; // ç”ºåã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã«ã‚ˆã‚Šè¡¨ç¤ºä»¶æ•°ã‚’å¢—åŠ 
            const displayResults = currentSearchResults.slice(0, maxDisplay);

            // ç”ºåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedByTown = groupPropertiesByTown(displayResults);

            // ç”ºåã‚’ã‚½ãƒ¼ãƒˆ
            const sortedTownNames = Object.keys(groupedByTown).sort((a, b) => {
                // "ä½æ‰€ä¸æ˜"ã‚’æœ€å¾Œã«ã‚½ãƒ¼ãƒˆ
                if (a === 'ä½æ‰€ä¸æ˜') return 1;
                if (b === 'ä½æ‰€ä¸æ˜') return -1;
                return a.localeCompare(b, 'ja');
            });

            let html = '';

            sortedTownNames.forEach(townName => {
                const properties = groupedByTown[townName];

                // ç”ºåã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
                html += `
                     <div class="town-group">
                         <div class="town-header" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åœ°åŸŸã®é †åºã‚’å¤‰æ›´ã§ãã¾ã™">
                             <span class="town-name">ğŸ“ ${escapeHtml(townName)} (${properties.length}ä»¶)</span>
                             <button class="town-map-btn" onclick="openRegionRoute('${escapeHtml(townName)}')" title="${escapeHtml(townName)}åœ°åŸŸã®ã¿ã§ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ">
                                 ğŸ—ºï¸ åœ°åŸŸãƒ«ãƒ¼ãƒˆ
                             </button>
                         </div>
                         <div class="town-properties">
                 `;

                // ãã®ç”ºã®ç‰©ä»¶ã‚’è¡¨ç¤º
                properties.forEach(property => {
                    const isAlreadySaved = savedProperties.some(saved => saved.propertyId === property.propertyId);
                    const saveButtonText = isAlreadySaved ? 'ä¿å­˜æ¸ˆã¿' : 'ä¿å­˜';
                    const saveButtonClass = isAlreadySaved ? 'button-secondary' : '';
                    const saveButtonDisabled = isAlreadySaved ? 'disabled' : '';
                    const mapLink = generateIndividualMapLink(property.address);

                    html += `
                         <div class="property-item">
                             <div class="property-info">
                                 <div class="property-name">${escapeHtml(property.propertyName || 'ç‰©ä»¶åä¸æ˜')}</div>
                                 <div class="property-address">
                                     <span style="margin-right: 8px;">${escapeHtml(property.address || 'ä½æ‰€ä¸æ˜')}</span>
                                     <a href="${mapLink}" target="_blank" class="map-link-small" title="ã“ã®ä½æ‰€ã‚’Googleãƒãƒƒãƒ—ã§é–‹ã">
                                         ğŸ—ºï¸ åœ°å›³
                                     </a>
                                 </div>
                                 <div class="property-id">ç‰©ä»¶ID: ${escapeHtml(property.propertyId || 'IDä¸æ˜')}</div>
                             </div>
                             <div class="property-actions">
                                 <button onclick="saveProperty('${property.propertyId}')" 
                                         class="${saveButtonClass}" 
                                         ${saveButtonDisabled}>
                                     ${saveButtonText}
                                 </button>
                             </div>
                         </div>
                     `;
                });

                html += `
                         </div>
                     </div>
                 `;
            });

            resultsContainer.innerHTML = html;

            // è¡¨ç¤ºä»¶æ•°åˆ¶é™ã®è­¦å‘Š
            if (currentSearchResults.length > maxDisplay) {
                resultsContainer.innerHTML += `
                     <div class="error">
                         æ³¨æ„: æ¤œç´¢çµæœãŒå¤šã„ãŸã‚ã€æœ€åˆã®${maxDisplay}ä»¶ã®ã¿è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
                         æ¤œç´¢æ¡ä»¶ã‚’çµã‚Šè¾¼ã‚“ã§ãã ã•ã„ã€‚
                     </div>
                 `;
            }

            // ç”ºååˆ¥çµ±è¨ˆã‚’è¡¨ç¤º
            const townCount = sortedTownNames.length;
            if (townCount > 1) {
                const statsMessage = `${townCount}ã®ç”ºã«åˆ†ã‘ã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™`;
                showTownStats(statsMessage, groupedByTown);
            }

            // ç”ºåã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
            setTimeout(() => {
                initializeTownGroupDragAndDrop();
            }, 100);
        }

        /**
         * ç‰©ä»¶ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã™ã‚‹é–¢æ•°
         * é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€ä¿å­˜å¾Œã«UIã‚’æ›´æ–°ã™ã‚‹
         * @param {string} propertyId - ä¿å­˜ã™ã‚‹ç‰©ä»¶ã®ID
         */
        function saveProperty(propertyId) {
            // æ—¢ã«ä¿å­˜æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if (savedProperties.some(saved => saved.propertyId === propertyId)) {
                showMessage('ã“ã®ç‰©ä»¶ã¯æ—¢ã«ä¿å­˜æ¸ˆã¿ã§ã™', 'error');
                return;
            }

            // ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
            const property = allProperties.find(p => p.propertyId === propertyId);
            if (!property) {
                showMessage('ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            // ä¿å­˜å®Ÿè¡Œ
            savedProperties.push({
                ...property,
                savedAt: new Date().toISOString() // ä¿å­˜æ—¥æ™‚ã‚’è¿½åŠ 
            });

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            try {
                localStorage.setItem('savedProperties', JSON.stringify(savedProperties));
                showMessage(`ã€Œ${property.propertyName}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'success');

                // UIæ›´æ–°
                updateSavedPropertiesDisplay();
                updateMapLink();
                updateStats();
                displaySearchResults(); // ä¿å­˜çŠ¶æ…‹ã‚’åæ˜ 
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
                savedProperties.pop();
            }
        }

        /**
         * ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã‹ã‚‰å‰Šé™¤ã™ã‚‹é–¢æ•°
         * @param {string} propertyId - å‰Šé™¤ã™ã‚‹ç‰©ä»¶ã®ID
         */
        function removeSavedProperty(propertyId) {
            const index = savedProperties.findIndex(property => property.propertyId === propertyId);
            if (index === -1) {
                showMessage('å‰Šé™¤å¯¾è±¡ã®ç‰©ä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const removedProperty = savedProperties.splice(index, 1)[0];

            try {
                localStorage.setItem('savedProperties', JSON.stringify(savedProperties));
                showMessage(`ã€Œ${removedProperty.propertyName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');

                // UIæ›´æ–°
                updateSavedPropertiesDisplay();
                updateMapLink();
                updateStats();
                displaySearchResults(); // ä¿å­˜çŠ¶æ…‹ã‚’åæ˜ 
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                savedProperties.splice(index, 0, removedProperty);
            }
        }

        /**
         * ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
         * ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰å®Ÿè¡Œã™ã‚‹
         */
        function clearAllSaved() {
            if (savedProperties.length === 0) {
                showMessage('ä¿å­˜æ¸ˆã¿ç‰©ä»¶ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            if (confirm(`ä¿å­˜æ¸ˆã¿ã®${savedProperties.length}ä»¶ã®ç‰©ä»¶ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                savedProperties = [];

                try {
                    localStorage.setItem('savedProperties', JSON.stringify(savedProperties));
                    showMessage('ã™ã¹ã¦ã®ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');

                    // UIæ›´æ–°
                    updateSavedPropertiesDisplay();
                    updateMapLink();
                    updateStats();
                    displaySearchResults(); // ä¿å­˜çŠ¶æ…‹ã‚’åæ˜ 
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }
        }

        /**
 * ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
 * ç”ºåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦è¡¨ç¤ºã—ã€å‰Šé™¤ãƒœã‚¿ãƒ³ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®šã™ã‚‹
 */
        function updateSavedPropertiesDisplay() {
            const container = document.getElementById('savedProperties');
            const mapContainer = document.getElementById('mapLinkContainer');

            if (savedProperties.length === 0) {
                container.innerHTML = '<p class="loading">ä¿å­˜æ¸ˆã¿ç‰©ä»¶ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                mapContainer.innerHTML = '<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; color: #666; text-align: center;">ç‰©ä»¶ã‚’ä¿å­˜ã™ã‚‹ã¨ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºãŒåˆ©ç”¨ã§ãã¾ã™</div>';
                return;
            }

            // ç”ºåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedByTown = groupPropertiesByTown(savedProperties);

            // ç”ºåã‚’ã‚½ãƒ¼ãƒˆ
            const sortedTownNames = Object.keys(groupedByTown).sort((a, b) => {
                if (a === 'ä½æ‰€ä¸æ˜') return 1;
                if (b === 'ä½æ‰€ä¸æ˜') return -1;
                return a.localeCompare(b, 'ja');
            });

            let html = '';
            let totalCount = 0;

            sortedTownNames.forEach(townName => {
                const properties = groupedByTown[townName];

                // ä¿å­˜æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                const sortedProperties = [...properties].sort((a, b) =>
                    new Date(b.savedAt || 0) - new Date(a.savedAt || 0)
                );

                // ç”ºåã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
                html += `
                     <div class="town-group">
                         <div class="town-header" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åœ°åŸŸã®é †åºã‚’å¤‰æ›´ã§ãã¾ã™">
                             <span class="town-name">ğŸ’¾ ${escapeHtml(townName)} (ä¿å­˜æ¸ˆã¿: ${properties.length}ä»¶)</span>
                             <button class="town-map-btn" onclick="openRegionRoute('${escapeHtml(townName)}')" title="${escapeHtml(townName)}åœ°åŸŸã®ã¿ã§ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ">
                                 ğŸ—ºï¸ åœ°åŸŸãƒ«ãƒ¼ãƒˆ
                             </button>
                         </div>
                         <div class="town-properties">
                 `;

                // ãã®ç”ºã®ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã‚’è¡¨ç¤º
                sortedProperties.forEach(property => {
                    totalCount++;
                    const mapLink = generateIndividualMapLink(property.address);
                    html += `
                         <div class="property-item">
                             <div class="property-info">
                                 <div class="property-name">${totalCount}. ${escapeHtml(property.propertyName || 'ç‰©ä»¶åä¸æ˜')}</div>
                                 <div class="property-address">
                                     <span style="margin-right: 8px;">${escapeHtml(property.address || 'ä½æ‰€ä¸æ˜')}</span>
                                     <a href="${mapLink}" target="_blank" class="map-link-small" title="ã“ã®ä½æ‰€ã‚’Googleãƒãƒƒãƒ—ã§é–‹ã">
                                         ğŸ—ºï¸ åœ°å›³
                                     </a>
                                 </div>
                                 <div class="property-id">
                                     ç‰©ä»¶ID: ${escapeHtml(property.propertyId || 'IDä¸æ˜')}
                                     ${property.savedAt ? ` | ä¿å­˜æ—¥: ${new Date(property.savedAt).toLocaleString('ja-JP')}` : ''}
                                 </div>
                             </div>
                             <div class="property-actions">
                                 <button onclick="removeSavedProperty('${property.propertyId}')" class="button-danger">
                                     å‰Šé™¤
                                 </button>
                             </div>
                         </div>
                     `;
                });

                html += `
                         </div>
                     </div>
                 `;
            });

            container.innerHTML = html;

            // ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã®ç”ºååˆ¥çµ±è¨ˆã‚’è¡¨ç¤º
            if (sortedTownNames.length > 1) {
                const savedStatsMessage = `ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã‚’${sortedTownNames.length}ã®ç”ºã«åˆ†ã‘ã¦è¡¨ç¤º`;
                showSavedStats(savedStatsMessage, groupedByTown);
            }

            // ç”ºåã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
            setTimeout(() => {
                initializeTownGroupDragAndDrop();
            }, 100);
        }

        /**
 * ä½æ‰€ã‹ã‚‰åœ°åŸŸã®åº§æ¨™ã‚’æ¨å®šã™ã‚‹é–¢æ•°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
 * @param {string} address - ä½æ‰€
 * @returns {Object} æ¨å®šåº§æ¨™ {lat, lng}
 */
        function estimateCoordinates(address) {
            console.log('estimateCoordinateså‘¼ã³å‡ºã—:', address);
            if (!address) {
                console.log('ä½æ‰€ãŒç©ºã€nullã‚’è¿”ã™');
                return null;
            }

            // æ—¥æœ¬ã®ä¸»è¦éƒ½å¸‚ã®æ¦‚ç®—åº§æ¨™ï¼ˆå‚è€ƒå€¤ï¼‰
            const cityCoordinates = {
                'é‡ç”°å¸‚': { lat: 35.9564, lng: 139.8753 },
                'æŸå¸‚': { lat: 35.8617, lng: 139.9693 },
                'éŒã‚±è°·å¸‚': { lat: 35.7770, lng: 140.0010 },
                'æˆ‘å­«å­å¸‚': { lat: 35.8644, lng: 140.0186 },
                'æ¾æˆ¸å¸‚': { lat: 35.7873, lng: 139.9018 },
                'æµå±±å¸‚': { lat: 35.8563, lng: 139.9252 },
                'ç™½äº•å¸‚': { lat: 35.7914, lng: 140.0563 }
            };

            // å¤§å¡šé§è»Šå ´ã®å ´åˆã¯æ­£ç¢ºãªåº§æ¨™ã‚’è¿”ã™
            if (address && (address.includes('åƒè‘‰çœŒæŸå¸‚ä¸­å¤®ï¼‘ä¸ç›®ï¼‘âˆ’ï¼“') || address.includes('å¤§å¡šé§è»Šå ´'))) {
                console.log('å¤§å¡šé§è»Šå ´ã®åº§æ¨™ã‚’è¿”ã™:', address);
                return { lat: 35.8617, lng: 139.9693 }; // æŸå¸‚ä¸­å¤®ã®åº§æ¨™
            }

            // å¸‚åŒºç”ºæ‘ã‚’æŠ½å‡º
            const cityMatch = address.match(/([^éƒ½é“åºœçœŒ]+[å¸‚åŒºç”ºæ‘])/);
            console.log('å¸‚åŒºç”ºæ‘ãƒãƒƒãƒãƒ³ã‚°:', { address, cityMatch });
            if (cityMatch) {
                const city = cityMatch[1];
                console.log('æŠ½å‡ºã•ã‚ŒãŸå¸‚åŒºç”ºæ‘:', city);
                if (cityCoordinates[city]) {
                    console.log('åº§æ¨™ç™ºè¦‹:', cityCoordinates[city]);
                    return cityCoordinates[city];
                } else {
                    console.log('åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãªã—:', city);
                }
            }

            console.log('åº§æ¨™å–å¾—å¤±æ•—ã€nullã‚’è¿”ã™');
            return null;
        }

        /**
         * 2ç‚¹é–“ã®è·é›¢ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆç°¡æ˜“ç‰ˆãƒ»ç›´ç·šè·é›¢ï¼‰
         * @param {Object} coord1 - åº§æ¨™1 {lat, lng}
         * @param {Object} coord2 - åº§æ¨™2 {lat, lng}
         * @returns {number} è·é›¢ï¼ˆkmï¼‰
         */
        function calculateDistance(coord1, coord2) {
            if (!coord1 || !coord2) return Infinity;

            const R = 6371; // åœ°çƒã®åŠå¾„ï¼ˆkmï¼‰
            const dLat = (coord2.lat - coord1.lat) * Math.PI / 180;
            const dLng = (coord2.lng - coord1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(coord1.lat * Math.PI / 180) * Math.cos(coord2.lat * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        /**
         * åœ°åŸŸãƒ™ãƒ¼ã‚¹ã§ç‰©ä»¶ã‚’ä¸¦ã³æ›¿ãˆã‚‹é–¢æ•°
         * @param {Array} properties - ç‰©ä»¶é…åˆ—
         * @returns {Array} ä¸¦ã³æ›¿ãˆã‚‰ã‚ŒãŸç‰©ä»¶é…åˆ—
         */
        function sortPropertiesByRegion(properties) {
            // å„ç‰©ä»¶ã«åº§æ¨™ã‚’ä»˜ä¸
            const propertiesWithCoords = properties.map(property => ({
                ...property,
                coords: estimateCoordinates(property.address),
                townName: extractTownName(property.address)
            }));

            // ç”ºåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã€ç”ºåé †ã«ã‚½ãƒ¼ãƒˆ
            const groupedByTown = {};
            propertiesWithCoords.forEach(property => {
                const town = property.townName;
                if (!groupedByTown[town]) {
                    groupedByTown[town] = [];
                }
                groupedByTown[town].push(property);
            });

            // ç”ºåã‚’ã‚½ãƒ¼ãƒˆã—ã€ç”ºå†…ã§ã¯ä¿å­˜é †ã‚’ç¶­æŒ
            const sortedTowns = Object.keys(groupedByTown).sort((a, b) => {
                if (a === 'ä½æ‰€ä¸æ˜') return 1;
                if (b === 'ä½æ‰€ä¸æ˜') return -1;
                return a.localeCompare(b, 'ja');
            });

            // çµæœã‚’æ§‹ç¯‰
            const sortedProperties = [];
            sortedTowns.forEach(town => {
                sortedProperties.push(...groupedByTown[town]);
            });

            return sortedProperties;
        }

        /**
 * æœ€çŸ­è·é›¢ãƒ«ãƒ¼ãƒˆã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆè²ªæ¬²æ³•ï¼‰
 * @param {Array} properties - ç‰©ä»¶é…åˆ—
 * @param {Object} finalDestination - æœ€çµ‚ç›®çš„åœ°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 * @returns {Array} æœ€é©åŒ–ã•ã‚ŒãŸç‰©ä»¶é…åˆ—
 */
        function optimizeRoute(properties, finalDestination = null) {
            console.log('optimizeRouteé–‹å§‹:', {
                propertiesCount: properties.length,
                finalDestination: finalDestination ? finalDestination.propertyName : 'ãªã—'
            });

            if (properties.length <= 2) {
                console.log('ç‰©ä»¶æ•°ãŒå°‘ãªã„ãŸã‚ã€ãã®ã¾ã¾è¿”ã™');
                return properties;
            }

            // åº§æ¨™ãŒå–å¾—ã§ããªã„ç‰©ä»¶ã¯åœ°åŸŸãƒ™ãƒ¼ã‚¹ã‚½ãƒ¼ãƒˆã‚’ä½¿ç”¨
            const propertiesWithCoords = properties.map(property => ({
                ...property,
                coords: estimateCoordinates(property.address)
            }));

            const validCoordProperties = propertiesWithCoords.filter(p => p.coords);
            const invalidCoordProperties = propertiesWithCoords.filter(p => !p.coords);

            console.log('åº§æ¨™å–å¾—çµæœ:', {
                valid: validCoordProperties.length,
                invalid: invalidCoordProperties.length
            });

            if (validCoordProperties.length <= 2) {
                // åº§æ¨™ãŒä¸ååˆ†ãªå ´åˆã¯åœ°åŸŸãƒ™ãƒ¼ã‚¹ã‚½ãƒ¼ãƒˆã‚’ä½¿ç”¨
                console.log('åº§æ¨™ãŒä¸ååˆ†ã€åœ°åŸŸãƒ™ãƒ¼ã‚¹ã‚½ãƒ¼ãƒˆã‚’ä½¿ç”¨');
                return sortPropertiesByRegion(properties);
            }

            // æœ€çµ‚ç›®çš„åœ°ãŒã‚ã‚‹å ´åˆã®æœ€é©åŒ–
            if (finalDestination && finalDestination.coords) {
                console.log('æœ€çµ‚ç›®çš„åœ°ã‚ã‚Šã€optimizeRouteWithDestinationã‚’å‘¼ã³å‡ºã—');
                return optimizeRouteWithDestination(validCoordProperties, finalDestination, invalidCoordProperties);
            }

            // æœ€çŸ­è·é›¢ãƒ«ãƒ¼ãƒˆã‚’è¨ˆç®—ï¼ˆè²ªæ¬²æ³•ï¼‰
            const optimized = [];
            const remaining = [...validCoordProperties];

            // æœ€åˆã®ç‰©ä»¶ã‚’å‡ºç™ºç‚¹ã¨ã—ã¦é¸æŠ
            let current = remaining.shift();
            optimized.push(current);

            // è²ªæ¬²æ³•ã§æœ€ã‚‚è¿‘ã„ç‰©ä»¶ã‚’é †æ¬¡é¸æŠ
            while (remaining.length > 0) {
                let nearestIndex = 0;
                let nearestDistance = Infinity;

                remaining.forEach((property, index) => {
                    const distance = calculateDistance(current.coords, property.coords);
                    if (distance < nearestDistance) {
                        nearestDistance = distance;
                        nearestIndex = index;
                    }
                });

                current = remaining.splice(nearestIndex, 1)[0];
                optimized.push(current);
            }

            // åº§æ¨™ãŒå–å¾—ã§ããªã‹ã£ãŸç‰©ä»¶ã‚’æœ€å¾Œã«è¿½åŠ 
            optimized.push(...invalidCoordProperties);

            return optimized;
        }

        /**
         * æœ€çµ‚ç›®çš„åœ°ã‚’è€ƒæ…®ã—ãŸãƒ«ãƒ¼ãƒˆæœ€é©åŒ–é–¢æ•°
         * @param {Array} validCoordProperties - åº§æ¨™ãŒæœ‰åŠ¹ãªç‰©ä»¶é…åˆ—
         * @param {Object} finalDestination - æœ€çµ‚ç›®çš„åœ°
         * @param {Array} invalidCoordProperties - åº§æ¨™ãŒç„¡åŠ¹ãªç‰©ä»¶é…åˆ—
         * @returns {Array} æœ€é©åŒ–ã•ã‚ŒãŸç‰©ä»¶é…åˆ—
         */
        function optimizeRouteWithDestination(validCoordProperties, finalDestination, invalidCoordProperties) {
            console.log('optimizeRouteWithDestinationé–‹å§‹:', {
                validCoordProperties: validCoordProperties.length,
                finalDestination: finalDestination.propertyName,
                finalDestinationCoords: finalDestination.coords
            });

            if (validCoordProperties.length <= 1) {
                console.log('æœ‰åŠ¹åº§æ¨™ç‰©ä»¶ãŒ1ä»¶ä»¥ä¸‹ã€ãã®ã¾ã¾è¿”ã™');
                return [...validCoordProperties, ...invalidCoordProperties];
            }

            // æœ€çµ‚ç›®çš„åœ°ã«æœ€ã‚‚è¿‘ã„ç‰©ä»¶ã‚’æœ€å¾Œã«é…ç½®ã™ã‚‹ãŸã‚ã«é€†ç®—ã§æœ€é©åŒ–
            const optimized = [];
            const remaining = [...validCoordProperties];

            // æœ€çµ‚ç›®çš„åœ°ã«æœ€ã‚‚è¿‘ã„ç‰©ä»¶ã‚’è¦‹ã¤ã‘ã¦æœ€å¾Œã«ã™ã‚‹
            let lastPropertyIndex = 0;
            let shortestToDestination = Infinity;

            console.log('æœ€çµ‚ç›®çš„åœ°ã¸ã®è·é›¢è¨ˆç®—é–‹å§‹...');
            remaining.forEach((property, index) => {
                const distanceToDestination = calculateDistance(property.coords, finalDestination.coords);
                console.log(`${property.propertyName} â†’ ${finalDestination.propertyName}: ${distanceToDestination.toFixed(2)}km`);
                if (distanceToDestination < shortestToDestination) {
                    shortestToDestination = distanceToDestination;
                    lastPropertyIndex = index;
                }
            });

            const lastProperty = remaining.splice(lastPropertyIndex, 1)[0];
            console.log(`æœ€çµ‚ç›®çš„åœ°ã«æœ€ã‚‚è¿‘ã„ç‰©ä»¶: ${lastProperty.propertyName} (è·é›¢: ${shortestToDestination.toFixed(2)}km)`);

            // æ®‹ã‚Šã®ç‰©ä»¶ã§æœ€çŸ­ãƒ«ãƒ¼ãƒˆã‚’æ§‹ç¯‰
            console.log('æœ€çŸ­ãƒ«ãƒ¼ãƒˆæ§‹ç¯‰é–‹å§‹...');
            if (remaining.length > 0) {
                let current = remaining.shift();
                optimized.push(current);
                console.log(`å‡ºç™ºåœ°: ${current.propertyName}`);

                // æœ€å¾Œã®ç‰©ä»¶ï¼ˆç›®çš„åœ°ã«è¿‘ã„ç‰©ä»¶ï¼‰ã¾ã§æœ€çŸ­ãƒ«ãƒ¼ãƒˆã§å·¡å›
                while (remaining.length > 0) {
                    let nearestIndex = 0;
                    let nearestDistance = Infinity;

                    remaining.forEach((property, index) => {
                        const distance = calculateDistance(current.coords, property.coords);
                        if (distance < nearestDistance) {
                            nearestDistance = distance;
                            nearestIndex = index;
                        }
                    });

                    current = remaining.splice(nearestIndex, 1)[0];
                    optimized.push(current);
                    console.log(`æ¬¡ã®çµŒç”±åœ°: ${current.propertyName} (å‰ã®ç‰©ä»¶ã‹ã‚‰ã®è·é›¢: ${nearestDistance.toFixed(2)}km)`);
                }
            }

            // æœ€çµ‚ç›®çš„åœ°ã«è¿‘ã„ç‰©ä»¶ã‚’æœ€å¾Œã«è¿½åŠ 
            optimized.push(lastProperty);
            console.log(`æœ€çµ‚çµŒç”±åœ°: ${lastProperty.propertyName} (å¤§å¡šé§è»Šå ´ã«æœ€ã‚‚è¿‘ã„)`);

            // åº§æ¨™ãŒå–å¾—ã§ããªã‹ã£ãŸç‰©ä»¶ã‚’æœ€å¾Œã«è¿½åŠ 
            optimized.push(...invalidCoordProperties);
            if (invalidCoordProperties.length > 0) {
                console.log('åº§æ¨™ä¸æ˜ç‰©ä»¶ã‚’æœ€å¾Œã«è¿½åŠ :', invalidCoordProperties.map(p => p.propertyName));
            }

            console.log('æœ€çµ‚çš„ãªæœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ:', optimized.map(p => p.propertyName));
            return optimized;
        }

        /**
         * Googleãƒãƒƒãƒ—ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆãƒ»æ›´æ–°ã™ã‚‹é–¢æ•°
         * ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã®ä½æ‰€ã‚’æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã§è¡¨ç¤º
         */
        function updateMapLink() {
            const container = document.getElementById('mapLinkContainer');

            if (savedProperties.length === 0) {
                container.innerHTML = '<p class="loading">ä¿å­˜æ¸ˆã¿ç‰©ä»¶ãŒãªã„ãŸã‚ã€ãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“</p>';
                return;
            }

            if (savedProperties.length === 1) {
                // 1ä»¶ã®å ´åˆã¯å˜ç´”ãªå ´æ‰€è¡¨ç¤º
                const address = encodeURIComponent(savedProperties[0].address || '');
                const singleLocationUrl = `https://www.google.com/maps/search/${address}`;

                container.innerHTML = `
                     <p><strong>ä¿å­˜æ¸ˆã¿ç‰©ä»¶:</strong> 1ä»¶</p>
                     <a href="${singleLocationUrl}" target="_blank" class="map-link">
                         ğŸ“ Googleãƒãƒƒãƒ—ã§è¡¨ç¤º
                     </a>
                 `;
                return;
            }

            // è¤‡æ•°ä»¶ã®å ´åˆã¯çµŒè·¯è¡¨ç¤º
            try {
                const validProperties = savedProperties.filter(property =>
                    property.address && property.address.trim() !== ''
                );

                if (validProperties.length === 0) {
                    container.innerHTML = '<p class="error">æœ‰åŠ¹ãªä½æ‰€ãŒãªã„ãŸã‚ã€ãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“</p>';
                    return;
                }

                // å›ºå®šåˆ°ç€åœ°ç‚¹ã®è¨­å®šã‚’ç¢ºèª
                const useCustomDestination = getCustomDestinationEnabled();
                let customDestination = null;

                console.log('å¤§å¡šé§è»Šå ´è¨­å®šç¢ºèª:', {
                    useCustomDestination,
                    savedValue: localStorage.getItem('useCustomDestination')
                });

                if (useCustomDestination) {
                    // å›ºå®šåˆ°ç€åœ°ç‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                    const destinationAddress = getCustomDestinationAddress();
                    const destinationCoords = estimateCoordinates(destinationAddress);

                    customDestination = {
                        propertyName: 'å¤§å¡šé§è»Šå ´',
                        address: destinationAddress,
                        propertyId: 'custom-destination',
                        coords: destinationCoords
                    };

                    console.log('å¤§å¡šé§è»Šå ´ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ:', {
                        address: destinationAddress,
                        coords: destinationCoords
                    });
                }

                // ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆå¤§å¡šé§è»Šå ´ã‚’è€ƒæ…®ï¼‰
                const optimizationType = getSelectedOptimization();
                let sortedProperties;

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
                console.log('æœ€é©åŒ–å‡¦ç†é–‹å§‹:', {
                    optimizationType,
                    useCustomDestination,
                    customDestination: customDestination ? 'è¨­å®šæ¸ˆã¿' : 'æœªè¨­å®š',
                    validPropertiesCount: validProperties.length
                });

                switch (optimizationType) {
                    case 'saved_order':
                        sortedProperties = validProperties;
                        console.log('ä¿å­˜é †ã§ä¸¦ã³æ›¿ãˆå®Œäº†');
                        break;
                    case 'region_based':
                        // åœ°åŸŸåˆ¥ã‚½ãƒ¼ãƒˆã®é †åºãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãã†ã§ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åœ°åŸŸåˆ¥ã‚½ãƒ¼ãƒˆ
                        const regionSortOrder = getRegionSortOrder();
                        if (regionSortOrder && regionSortOrder.length > 0) {
                            sortedProperties = regionSortOrder;
                            console.log('ã‚«ã‚¹ã‚¿ãƒ åœ°åŸŸé †åºã§ä¸¦ã³æ›¿ãˆå®Œäº†');
                        } else {
                            sortedProperties = sortPropertiesByRegion(validProperties);
                            console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåœ°åŸŸåˆ¥ã§ä¸¦ã³æ›¿ãˆå®Œäº†');
                        }
                        break;
                    case 'region_select':
                        // é¸æŠã•ã‚ŒãŸåœ°åŸŸã®ã¿ã®ç‰©ä»¶ã‚’å–å¾—
                        const selectedRegions = getSelectedRegions();
                        if (selectedRegions.length > 0) {
                            sortedProperties = validProperties.filter(property => {
                                const propertyTown = extractTownName(property.address);
                                return selectedRegions.includes(propertyTown);
                            });
                            // åœ°åŸŸåˆ¥ã«ã‚½ãƒ¼ãƒˆ
                            sortedProperties = sortPropertiesByRegion(sortedProperties);
                            console.log('åœ°åŸŸé¸æŠã§ä¸¦ã³æ›¿ãˆå®Œäº†:', selectedRegions, sortedProperties.length + 'ä»¶');
                        } else {
                            // åœ°åŸŸãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç©ºé…åˆ—
                            sortedProperties = [];
                            console.log('åœ°åŸŸãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        }
                        break;
                    case 'distance_optimized':
                        // å¤§å¡šé§è»Šå ´ã‚’è€ƒæ…®ã—ãŸè·é›¢æœ€é©åŒ–
                        console.log('è·é›¢æœ€é©åŒ–é–‹å§‹ - å¤§å¡šé§è»Šå ´:', customDestination ? 'è€ƒæ…®ã™ã‚‹' : 'è€ƒæ…®ã—ãªã„');
                        sortedProperties = optimizeRoute(validProperties, customDestination);
                        console.log('è·é›¢æœ€é©åŒ–å®Œäº†:', sortedProperties.map(p => p.propertyName));
                        break;
                    case 'manual':
                        sortedProperties = getManualSortOrder() || validProperties;
                        console.log('æ‰‹å‹•ä¸¦ã³æ›¿ãˆå®Œäº†');
                        break;
                    default:
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯åœ°åŸŸåˆ¥
                        console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåœ°åŸŸåˆ¥é–‹å§‹');
                        sortedProperties = sortPropertiesByRegion(validProperties);
                        console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåœ°åŸŸåˆ¥å®Œäº†:', sortedProperties.map(p => p.propertyName));
                }

                // æœ€çµ‚çš„ãªç‰©ä»¶é…åˆ—ã‚’æ§‹ç¯‰
                let finalSortedProperties = [...sortedProperties];
                let addresses = sortedProperties.map(property => property.address);

                if (useCustomDestination && customDestination) {
                    finalSortedProperties.push(customDestination);
                    addresses.push(customDestination.address);
                }

                // Googleãƒãƒƒãƒ—ã®çµŒè·¯URLã‚’ç”Ÿæˆ
                const origin = encodeURIComponent(addresses[0]);
                const destination = encodeURIComponent(addresses[addresses.length - 1]);

                let mapUrl = `https://www.google.com/maps/dir/${origin}`;

                // ä¸­é–“ã®çµŒç”±åœ°ã‚’è¿½åŠ 
                if (addresses.length > 2) {
                    const waypoints = addresses.slice(1, -1).map(addr => encodeURIComponent(addr)).join('/');
                    mapUrl += `/${waypoints}`;
                }

                mapUrl += `/${destination}`;

                // æœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                mapUrl += '?travelmode=driving&optimize=true';

                // ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ã®èª¬æ˜ã‚’è¡¨ç¤º
                container.innerHTML = generateRouteDisplay(finalSortedProperties, addresses, mapUrl, optimizationType);

                // æ‰‹å‹•ä¸¦ã³æ›¿ãˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ‡ãƒã‚¤ã‚¹ã«å¿œã˜ãŸåˆæœŸåŒ–
                if (optimizationType === 'manual') {
                    setTimeout(() => {
                        if (isTouchDevice()) {
                            initializeTouchInterface();
                        } else {
                            initializeDragAndDrop();
                        }
                    }, 100); // UIã®æç”»å®Œäº†ã‚’å¾…ã¤
                }

                // åœ°åŸŸåˆ¥ã‚½ãƒ¼ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€åœ°åŸŸãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–
                if (optimizationType === 'region_based') {
                    setTimeout(() => {
                        initializeRegionDragAndDrop();
                        if (isTouchDevice()) {
                            updateRegionMobileButtons();
                        }
                    }, 100); // UIã®æç”»å®Œäº†ã‚’å¾…ã¤
                }

            } catch (error) {
                console.error('ãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                container.innerHTML = '<p class="error">ãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        /**
         * ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºã®HTMLã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
         */
        function generateRouteDisplay(sortedProperties, addresses, mapUrl, optimizationType) {
            const optimizationLabels = {
                'saved_order': 'ä¿å­˜é †',
                'region_based': 'åœ°åŸŸåˆ¥',
                'region_select': 'åœ°åŸŸé¸æŠ',
                'distance_optimized': 'è·é›¢æœ€é©åŒ–',
                'manual': 'æ‰‹å‹•ä¸¦ã³æ›¿ãˆ'
            };

            return `
                 <div class="route-optimization">
                     <div class="route-optimization-header">
                         ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                     </div>
                     <div class="route-options">
                         <div class="route-option">
                             <input type="radio" id="saved_order" name="optimization" value="saved_order" ${optimizationType === 'saved_order' ? 'checked' : ''} onchange="updateMapLink()">
                             <label for="saved_order">ä¿å­˜é †</label>
                         </div>
                         <div class="route-option">
                             <input type="radio" id="region_based" name="optimization" value="region_based" ${optimizationType === 'region_based' ? 'checked' : ''} onchange="updateMapLink()">
                             <label for="region_based">åœ°åŸŸåˆ¥ (æ¨å¥¨)</label>
                         </div>
                         <div class="route-option">
                             <input type="radio" id="region_select" name="optimization" value="region_select" ${optimizationType === 'region_select' ? 'checked' : ''} onchange="updateMapLink()">
                             <label for="region_select">åœ°åŸŸé¸æŠ</label>
                         </div>
                         <div class="route-option">
                             <input type="radio" id="distance_optimized" name="optimization" value="distance_optimized" ${optimizationType === 'distance_optimized' ? 'checked' : ''} onchange="updateMapLink()">
                             <label for="distance_optimized">è·é›¢æœ€é©åŒ–</label>
                         </div>
                         <div class="route-option">
                             <input type="radio" id="manual" name="optimization" value="manual" ${optimizationType === 'manual' ? 'checked' : ''} onchange="updateMapLink()">
                             <label for="manual">æ‰‹å‹•ä¸¦ã³æ›¿ãˆ</label>
                         </div>
                     </div>
                     
                     <div class="destination-option">
                         <div class="destination-option-header">
                             ğŸ åˆ°ç€åœ°ç‚¹ã®è¨­å®š
                         </div>
                         <div class="destination-choice">
                             <input type="checkbox" id="useCustomDestination" onchange="handleCustomDestinationChange()" ${getCustomDestinationEnabled() ? 'checked' : ''}>
                             <label for="useCustomDestination">å¤§å¡šé§è»Šå ´ã‚’æœ€çµ‚ç›®çš„åœ°ã«ã™ã‚‹</label>
                         </div>
                         <div class="custom-destination">
                             ğŸ…¿ï¸ å¤§å¡šé§è»Šå ´<br>
                             ğŸ“ åƒè‘‰çœŒæŸå¸‚ä¸­å¤®ï¼‘ä¸ç›®ï¼‘âˆ’ï¼“
                         </div>
                         <div style="font-size: 12px; color: #666; margin-top: 5px;">
                             â€» ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ã€ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã®æœ€å¾ŒãŒç›®çš„åœ°ã«ãªã‚Šã¾ã™<br>
                             â€» ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€ã™ã¹ã¦ã®ç‰©ä»¶ã‚’å›ã£ãŸå¾Œã«å¤§å¡šé§è»Šå ´ã«å‘ã‹ã„ã¾ã™
                         </div>
                     </div>
                     
                     ${optimizationType === 'manual' ? generateManualSortInterface(sortedProperties) : ''}
                     ${optimizationType === 'region_based' ? generateRegionBasedSortInterface(sortedProperties) : ''}
                     ${optimizationType === 'region_select' ? generateRegionSelectInterface(sortedProperties) : ''}
                 </div>
                 
                 <div style="margin-top: 20px;">
                     <p><strong>çµŒè·¯æƒ…å ±:</strong> ${addresses.length}ç®‡æ‰€ã‚’${optimizationLabels[optimizationType]}ã§è¡¨ç¤º${getCustomDestinationEnabled() ? ' + å¤§å¡šé§è»Šå ´' : ''}</p>
                     <a href="${mapUrl}" target="_blank" class="map-link">
                         ğŸ—ºï¸ Googleãƒãƒƒãƒ—ã§æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º
                     </a>
                 </div>
             `;
        }

        /**
         * çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         * ç·ç‰©ä»¶æ•°ã€æ¤œç´¢çµæœæ•°ã€ä¿å­˜æ¸ˆã¿ä»¶æ•°ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹
         */
        function updateStats() {
            document.getElementById('totalProperties').textContent = allProperties.length.toLocaleString();
            document.getElementById('searchResultCount').textContent = currentSearchResults.length.toLocaleString();
            document.getElementById('savedCount').textContent = savedProperties.length.toLocaleString();
        }

        /**
         * éƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹é–¢æ•°
         * ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¸€æ„ã®åœ°åŸŸãƒªã‚¹ãƒˆã‚’æŠ½å‡ºã—ã¦ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¨­å®šã™ã‚‹
         */
        function populateLocationFilters() {
            const prefectures = new Set();
            const cities = new Set();

            allProperties.forEach(property => {
                if (property.address) {
                    // ä½æ‰€ã‹ã‚‰éƒ½é“åºœçœŒã‚’æŠ½å‡ºï¼ˆä¾‹: "åƒè‘‰çœŒé‡ç”°å¸‚..." â†’ "åƒè‘‰çœŒ"ï¼‰
                    const prefMatch = property.address.match(/^(.*?[éƒ½é“åºœçœŒ])/);
                    if (prefMatch) {
                        prefectures.add(prefMatch[1]);
                    }

                    // ä½æ‰€ã‹ã‚‰å¸‚åŒºç”ºæ‘ã‚’æŠ½å‡ºï¼ˆä¾‹: "åƒè‘‰çœŒé‡ç”°å¸‚..." â†’ "é‡ç”°å¸‚"ï¼‰
                    const cityMatch = property.address.match(/[éƒ½é“åºœçœŒ](.*?[å¸‚åŒºç”ºæ‘])/);
                    if (cityMatch) {
                        cities.add(cityMatch[1]);
                    }
                }
            });

            // éƒ½é“åºœçœŒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«è¿½åŠ 
            const prefSelect = document.getElementById('prefectureFilter');
            Array.from(prefectures).sort().forEach(pref => {
                const option = document.createElement('option');
                option.value = pref;
                option.textContent = pref;
                prefSelect.appendChild(option);
            });

            // å¸‚åŒºç”ºæ‘ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«è¿½åŠ 
            const citySelect = document.getElementById('cityFilter');
            Array.from(cities).sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }

        /**
         * éƒ½é“åºœçœŒã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
         */
        function filterByPrefecture() {
            const selectedPref = document.getElementById('prefectureFilter').value;

            if (!selectedPref) {
                currentSearchResults = [...allProperties];
            } else {
                currentSearchResults = allProperties.filter(property =>
                    property.address && property.address.includes(selectedPref)
                );
            }

            // å¸‚åŒºç”ºæ‘ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('cityFilter').value = '';

            displaySearchResults();
            updateStats();

            if (selectedPref) {
                showMessage(`${selectedPref}ã®ç‰©ä»¶ ${currentSearchResults.length}ä»¶ã‚’è¡¨ç¤º`, 'success');
            }
        }

        /**
         * å¸‚åŒºç”ºæ‘ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
         */
        function filterByCity() {
            const selectedCity = document.getElementById('cityFilter').value;

            if (!selectedCity) {
                filterByPrefecture(); // éƒ½é“åºœçœŒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã¿é©ç”¨
            } else {
                currentSearchResults = allProperties.filter(property =>
                    property.address && property.address.includes(selectedCity)
                );

                displaySearchResults();
                updateStats();
                showMessage(`${selectedCity}ã®ç‰©ä»¶ ${currentSearchResults.length}ä»¶ã‚’è¡¨ç¤º`, 'success');
            }
        }

        /**
         * ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹é–¢æ•°
         */
        function exportSavedProperties() {
            if (savedProperties.length === 0) {
                showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ç‰©ä»¶ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                const exportData = {
                    exportDate: new Date().toISOString(),
                    totalCount: savedProperties.length,
                    properties: savedProperties
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `saved_properties_${new Date().toISOString().split('T')[0]}.json`;

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(`${savedProperties.length}ä»¶ã®ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        /**
 * ç”ºååˆ¥çµ±è¨ˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
 * @param {string} message - åŸºæœ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @param {Object} groupedByTown - ç”ºåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
 */
        function showTownStats(message, groupedByTown) {
            // æ—¢å­˜ã®ç”ºåçµ±è¨ˆã‚’å‰Šé™¤
            const existingStats = document.querySelector('.town-stats');
            if (existingStats) {
                existingStats.remove();
            }

            // ç”ºååˆ¥ã®ç‰©ä»¶æ•°ã‚’ã‚½ãƒ¼ãƒˆï¼ˆç‰©ä»¶æ•°ã®å¤šã„é †ï¼‰
            const townStats = Object.entries(groupedByTown)
                .map(([townName, properties]) => ({ townName, count: properties.length }))
                .sort((a, b) => b.count - a.count);

            const statsDiv = document.createElement('div');
            statsDiv.className = 'town-stats';

            const topTowns = townStats.slice(0, 5); // ä¸Šä½5ç”ºã‚’è¡¨ç¤º
            const topTownsText = topTowns.map(town => `${town.townName}(${town.count}ä»¶)`).join('ã€');

            statsDiv.innerHTML = `
                 <strong>ğŸ“Š ${message}</strong>
                 <div class="town-stats-details">
                     ç‰©ä»¶æ•°ã®å¤šã„ç”º: ${topTownsText}
                     ${townStats.length > 5 ? `ã€ä»–${townStats.length - 5}ç”º` : ''}
                 </div>
             `;

            // æ¤œç´¢çµæœã®å‰ã«æŒ¿å…¥
            const searchResults = document.getElementById('searchResults');
            searchResults.parentNode.insertBefore(statsDiv, searchResults);
        }

        /**
         * ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã®ç”ºååˆ¥çµ±è¨ˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         * @param {string} message - åŸºæœ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         * @param {Object} groupedByTown - ç”ºåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
         */
        function showSavedStats(message, groupedByTown) {
            // æ—¢å­˜ã®ä¿å­˜æ¸ˆã¿çµ±è¨ˆã‚’å‰Šé™¤
            const existingStats = document.querySelector('.saved-town-stats');
            if (existingStats) {
                existingStats.remove();
            }

            // ç”ºååˆ¥ã®ç‰©ä»¶æ•°ã‚’ã‚½ãƒ¼ãƒˆï¼ˆç‰©ä»¶æ•°ã®å¤šã„é †ï¼‰
            const townStats = Object.entries(groupedByTown)
                .map(([townName, properties]) => ({ townName, count: properties.length }))
                .sort((a, b) => b.count - a.count);

            const statsDiv = document.createElement('div');
            statsDiv.className = 'town-stats saved-town-stats';
            statsDiv.style.background = '#e8f5e8';
            statsDiv.style.borderColor = '#c3e6c3';
            statsDiv.style.color = '#2e7d32';

            const topTowns = townStats.slice(0, 3); // ä¸Šä½3ç”ºã‚’è¡¨ç¤º
            const topTownsText = topTowns.map(town => `${town.townName}(${town.count}ä»¶)`).join('ã€');

            statsDiv.innerHTML = `
                 <strong>ğŸ’¾ ${message}</strong>
                 <div class="town-stats-details">
                     ä¿å­˜ä»¶æ•°ã®å¤šã„ç”º: ${topTownsText}
                     ${townStats.length > 3 ? `ã€ä»–${townStats.length - 3}ç”º` : ''}
                 </div>
             `;

            // ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã®å‰ã«æŒ¿å…¥
            const savedProperties = document.getElementById('savedProperties');
            savedProperties.parentNode.insertBefore(statsDiv, savedProperties);
        }

        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         * @param {string} type - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ï¼ˆ'success', 'error', 'loading'ï¼‰
         */
        function showMessage(message, type = 'success') {
            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¾Œã«æŒ¿å…¥
            const searchSection = document.querySelector('.subsection');
            searchSection.parentNode.insertBefore(messageDiv, searchSection.nextSibling);

            // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•å‰Šé™¤ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä»¥å¤–ï¼‰
            if (type !== 'loading') {
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 3000);
            }
        }

        /**
 * é¸æŠã•ã‚Œã¦ã„ã‚‹æœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
 * @returns {string} é¸æŠã•ã‚Œã¦ã„ã‚‹æœ€é©åŒ–ã‚¿ã‚¤ãƒ—
 */
        function getSelectedOptimization() {
            const selected = document.querySelector('input[name="optimization"]:checked');
            return selected ? selected.value : 'region_based'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯åœ°åŸŸåˆ¥
        }

        /**
         * å›ºå®šåˆ°ç€åœ°ç‚¹ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’å–å¾—ã™ã‚‹é–¢æ•°
         * ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’èª­ã¿å–ã‚‹
         * @returns {boolean} å›ºå®šåˆ°ç€åœ°ç‚¹ãŒæœ‰åŠ¹ã®å ´åˆtrue
         */
        function getCustomDestinationEnabled() {
            const saved = localStorage.getItem('useCustomDestination');
            return saved === 'true';
        }

        /**
         * å›ºå®šåˆ°ç€åœ°ç‚¹ã®ä½æ‰€ã‚’å–å¾—ã™ã‚‹é–¢æ•°
         * @returns {string} å›ºå®šåˆ°ç€åœ°ç‚¹ã®ä½æ‰€
         */
        function getCustomDestinationAddress() {
            return 'åƒè‘‰çœŒæŸå¸‚ä¸­å¤®ï¼‘ä¸ç›®ï¼‘âˆ’ï¼“';
        }

        /**
 * ãƒ‡ãƒã‚¤ã‚¹ãŒã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
 * @returns {boolean} ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã®å ´åˆtrue
 */
        function isTouchDevice() {
            return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        }

        /**
         * æ‰‹å‹•ä¸¦ã³æ›¿ãˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
         * @param {Array} properties - ç‰©ä»¶é…åˆ—
         * @returns {string} æ‰‹å‹•ä¸¦ã³æ›¿ãˆç”¨ã®HTML
         */
        function generateManualSortInterface(properties) {
            const isTouch = isTouchDevice();
            const instructionText = isTouch
                ? 'ğŸ“± ä¸Šä¸‹ãƒœã‚¿ãƒ³ã¾ãŸã¯ã‚¿ãƒƒãƒã§é †åºã‚’å¤‰æ›´ã—ã¦ãã ã•ã„:'
                : 'ğŸ“ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§é †åºã‚’å¤‰æ›´ã—ã¦ãã ã•ã„:';
            const detailText = isTouch
                ? 'â€» å„ç‰©ä»¶ã®ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§é †åºã‚’å¤‰æ›´ã™ã‚‹ã‹ã€ç‰©ä»¶ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠã—ã¦ã‹ã‚‰ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§ç§»å‹•ã§ãã¾ã™'
                : 'â€» ã€Œâ‰¡ã€ãƒãƒ¼ã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †åºã‚’å¤‰æ›´ã—ã€ã€Œé †åºã‚’é©ç”¨ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';

            return `
                 <div class="manual-sort">
                     <div style="font-weight: bold; margin-bottom: 10px; color: #856404;">
                         ${instructionText}
                     </div>
                     <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                         ${detailText}
                     </div>
                     ${isTouch ? generateTouchSortInterface(properties) : generateDragSortInterface(properties)}
                     <button onclick="applyManualSort()" class="button-secondary" style="margin-top: 15px;">
                         ğŸ“ é †åºã‚’é©ç”¨ã—ã¦ãƒãƒƒãƒ—ã‚’æ›´æ–°
                     </button>
                 </div>
             `;
        }

        /**
         * åœ°åŸŸåˆ¥ã‚½ãƒ¼ãƒˆç”¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
         * @param {Array} properties - ç‰©ä»¶é…åˆ—
         * @returns {string} åœ°åŸŸåˆ¥ã‚½ãƒ¼ãƒˆç”¨ã®HTML
         */
        function generateRegionBasedSortInterface(properties) {
            // åœ°åŸŸã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedByTown = groupPropertiesByTown(properties);
            const sortedTownNames = Object.keys(groupedByTown).sort((a, b) => {
                if (a === 'ä½æ‰€ä¸æ˜') return 1;
                if (b === 'ä½æ‰€ä¸æ˜') return -1;
                return a.localeCompare(b, 'ja');
            });

            const isTouch = isTouchDevice();
            const instructionText = isTouch
                ? 'ğŸ“± åœ°åŸŸã®é †åºã‚’ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§å¤‰æ›´ã—ã¦ãã ã•ã„:'
                : 'ğŸ˜ï¸ åœ°åŸŸã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§é †åºã‚’å¤‰æ›´ã—ã¦ãã ã•ã„:';
            const detailText = isTouch
                ? 'â€» å„åœ°åŸŸã®ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§é †åºã‚’å¤‰æ›´ã§ãã¾ã™'
                : 'â€» åœ°åŸŸãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †åºã‚’å¤‰æ›´ã—ã€ã€Œé †åºã‚’é©ç”¨ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';

            return `
                <div class="manual-sort region-sort">
                    <div style="font-weight: bold; margin-bottom: 10px; color: #856404;">
                        ${instructionText}
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        ${detailText}
                    </div>
                    ${isTouch ? generateTouchRegionSortInterface(groupedByTown, sortedTownNames) : generateDragRegionSortInterface(groupedByTown, sortedTownNames)}
                    <button onclick="applyRegionSort()" class="button-secondary" style="margin-top: 15px;">
                        ğŸ˜ï¸ åœ°åŸŸé †åºã‚’é©ç”¨ã—ã¦ãƒãƒƒãƒ—ã‚’æ›´æ–°
                    </button>
                </div>
            `;
        }

        /**
         * åœ°åŸŸãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”Ÿæˆ
         */
        function generateDragRegionSortInterface(groupedByTown, sortedTownNames) {
            return `
                <div class="region-sortable-container" id="regionSortableContainer">
                    ${sortedTownNames.map((townName, index) => {
                const properties = groupedByTown[townName];
                return `
                            <div class="region-group-sortable" data-town-name="${escapeHtml(townName)}" draggable="true">
                                <div class="region-header-sortable" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åœ°åŸŸã®é †åºã‚’å¤‰æ›´">
                                    <span class="region-drag-handle">â‹®â‹®</span>
                                    ğŸ“ ${escapeHtml(townName)} (${properties.length}ä»¶)
                                </div>
                                <div class="region-properties-list">
                                    ${properties.map((property, propIndex) => {
                    const mapLink = generateIndividualMapLink(property.address);
                    return `
                                            <div class="region-property-item">
                                                <div>
                                                    <strong>${escapeHtml(property.propertyName || 'ç‰©ä»¶åä¸æ˜')}</strong><br>
                                                    <small style="color: #666; margin-right: 8px;">${escapeHtml(property.address || 'ä½æ‰€ä¸æ˜')}</small>
                                                    <a href="${mapLink}" target="_blank" class="map-link-small" title="ã“ã®ä½æ‰€ã‚’Googleãƒãƒƒãƒ—ã§é–‹ã">
                                                        ğŸ—ºï¸ åœ°å›³
                                                    </a>
                                                </div>
                                            </div>
                                        `;
                }).join('')}
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        /**
         * ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨åœ°åŸŸã‚½ãƒ¼ãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”Ÿæˆ
         */
        function generateTouchRegionSortInterface(groupedByTown, sortedTownNames) {
            return `
                <div class="region-sortable-container" id="regionSortableContainer">
                    ${sortedTownNames.map((townName, index) => {
                const properties = groupedByTown[townName];
                return `
                            <div class="region-group-sortable" data-town-name="${escapeHtml(townName)}">
                                <div class="region-header-sortable">
                                    ğŸ“ ${escapeHtml(townName)} (${properties.length}ä»¶)
                                    <div class="region-mobile-controls">
                                        <button class="mobile-btn" onclick="moveRegionUp(event, '${escapeHtml(townName)}')" 
                                                ${index === 0 ? 'disabled' : ''} title="ä¸Šã«ç§»å‹•">
                                            â†‘
                                        </button>
                                        <button class="mobile-btn" onclick="moveRegionDown(event, '${escapeHtml(townName)}')" 
                                                ${index === sortedTownNames.length - 1 ? 'disabled' : ''} title="ä¸‹ã«ç§»å‹•">
                                            â†“
                                        </button>
                                    </div>
                                </div>
                                <div class="region-properties-list">
                                    ${properties.map((property, propIndex) => {
                    const mapLink = generateIndividualMapLink(property.address);
                    return `
                                            <div class="region-property-item">
                                                <div>
                                                    <strong>${escapeHtml(property.propertyName || 'ç‰©ä»¶åä¸æ˜')}</strong><br>
                                                    <small style="color: #666; margin-right: 8px;">${escapeHtml(property.address || 'ä½æ‰€ä¸æ˜')}</small>
                                                    <a href="${mapLink}" target="_blank" class="map-link-small" title="ã“ã®ä½æ‰€ã‚’Googleãƒãƒƒãƒ—ã§é–‹ã">
                                                        ğŸ—ºï¸ åœ°å›³
                                                    </a>
                                                </div>
                                            </div>
                                        `;
                }).join('')}
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        /**
         * ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”Ÿæˆ
         */
        function generateDragSortInterface(properties) {
            return `
                 <ul class="sortable-list" id="sortableList">
                     ${properties.map((property, index) => `
                         <li class="sortable-item" data-property-id="${property.propertyId}" draggable="true">
                             <span class="drag-handle" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †åºã‚’å¤‰æ›´">â‰¡</span>
                             <div style="flex: 1;">
                                 <strong>${index + 1}. ${escapeHtml(property.propertyName || 'ç‰©ä»¶åä¸æ˜')}</strong><br>
                                 <small style="color: #666;">${escapeHtml(property.address || 'ä½æ‰€ä¸æ˜')}</small>
                             </div>
                         </li>
                     `).join('')}
                 </ul>
             `;
        }

        /**
         * ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”Ÿæˆ
         */
        function generateTouchSortInterface(properties) {
            return `
                 <div class="touch-handle" onclick="clearSelection()">
                     ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠã‚’è§£é™¤
                 </div>
                 <ul class="sortable-list" id="sortableList">
                     ${properties.map((property, index) => `
                         <li class="sortable-item" data-property-id="${property.propertyId}" onclick="selectItem(this)">
                             <div style="flex: 1;" class="property-info-mobile">
                                 <strong>${index + 1}. ${escapeHtml(property.propertyName || 'ç‰©ä»¶åä¸æ˜')}</strong><br>
                                 <small style="color: #666;">${escapeHtml(property.address || 'ä½æ‰€ä¸æ˜')}</small>
                             </div>
                             <div class="mobile-controls">
                                 <button class="mobile-btn" onclick="moveUp(event, '${property.propertyId}')" 
                                         ${index === 0 ? 'disabled' : ''} title="ä¸Šã«ç§»å‹•">
                                     â†‘
                                 </button>
                                 <button class="mobile-btn" onclick="moveDown(event, '${property.propertyId}')" 
                                         ${index === properties.length - 1 ? 'disabled' : ''} title="ä¸‹ã«ç§»å‹•">
                                     â†“
                                 </button>
                             </div>
                         </li>
                     `).join('')}
                 </ul>
             `;
        }

        /**
         * æ‰‹å‹•ä¸¦ã³æ›¿ãˆã®é †åºã‚’å–å¾—ã™ã‚‹é–¢æ•°
         * @returns {Array|null} æ‰‹å‹•ä¸¦ã³æ›¿ãˆã•ã‚ŒãŸç‰©ä»¶é…åˆ—
         */
        function getManualSortOrder() {
            const sortableList = document.getElementById('sortableList');
            if (!sortableList) return null;

            const sortedIds = Array.from(sortableList.children).map(item =>
                item.getAttribute('data-property-id')
            );

            const sortedProperties = [];
            sortedIds.forEach(id => {
                const property = savedProperties.find(p => p.propertyId === id);
                if (property) {
                    sortedProperties.push(property);
                }
            });

            return sortedProperties;
        }

        /**
 * æ‰‹å‹•ä¸¦ã³æ›¿ãˆã‚’é©ç”¨ã™ã‚‹é–¢æ•°
 */
        function applyManualSort() {
            updateMapLink();
            showMessage('æ‰‹å‹•ä¸¦ã³æ›¿ãˆã‚’é©ç”¨ã—ã¾ã—ãŸ', 'success');
        }

        /**
         * ç‰©ä»¶ã‚’ä¸Šã«ç§»å‹•ã™ã‚‹é–¢æ•°ï¼ˆã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ï¼‰
         */
        function moveUp(event, propertyId) {
            event.stopPropagation();
            const sortableList = document.getElementById('sortableList');
            if (!sortableList) return;

            const items = Array.from(sortableList.children);
            const currentIndex = items.findIndex(item =>
                item.getAttribute('data-property-id') === propertyId
            );

            if (currentIndex > 0) {
                const currentItem = items[currentIndex];
                const previousItem = items[currentIndex - 1];
                sortableList.insertBefore(currentItem, previousItem);
                updateItemNumbers();
                updateMobileButtons();
                showMessage('ä¸Šã«ç§»å‹•ã—ã¾ã—ãŸ', 'success');
            }
        }

        /**
         * ç‰©ä»¶ã‚’ä¸‹ã«ç§»å‹•ã™ã‚‹é–¢æ•°ï¼ˆã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ï¼‰
         */
        function moveDown(event, propertyId) {
            event.stopPropagation();
            const sortableList = document.getElementById('sortableList');
            if (!sortableList) return;

            const items = Array.from(sortableList.children);
            const currentIndex = items.findIndex(item =>
                item.getAttribute('data-property-id') === propertyId
            );

            if (currentIndex < items.length - 1) {
                const currentItem = items[currentIndex];
                const nextItem = items[currentIndex + 1];
                sortableList.insertBefore(nextItem, currentItem);
                updateItemNumbers();
                updateMobileButtons();
                showMessage('ä¸‹ã«ç§»å‹•ã—ã¾ã—ãŸ', 'success');
            }
        }

        /**
         * ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã™ã‚‹é–¢æ•°ï¼ˆã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ï¼‰
         */
        function selectItem(element) {
            // æ—¢å­˜ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.sortable-item').forEach(item => {
                item.classList.remove('selected');
            });

            // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠ
            element.classList.add('selected');

            // é¸æŠçŠ¶æ…‹ã‚’visualã§è¡¨ç¤º
            element.style.background = '#e3f2fd';
            element.style.borderLeft = '4px solid #007bff';
        }

        /**
         * é¸æŠã‚’è§£é™¤ã™ã‚‹é–¢æ•°
         */
        function clearSelection() {
            document.querySelectorAll('.sortable-item').forEach(item => {
                item.classList.remove('selected');
                item.style.background = '';
                item.style.borderLeft = '';
            });
        }

        /**
         * ãƒ¢ãƒã‚¤ãƒ«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        function updateMobileButtons() {
            const sortableList = document.getElementById('sortableList');
            if (!sortableList) return;

            const items = Array.from(sortableList.children);
            items.forEach((item, index) => {
                const upBtn = item.querySelector('.mobile-btn:first-child');
                const downBtn = item.querySelector('.mobile-btn:last-child');

                if (upBtn) {
                    upBtn.disabled = index === 0;
                }
                if (downBtn) {
                    downBtn.disabled = index === items.length - 1;
                }
            });
        }

        /**
         * åœ°åŸŸåˆ¥ã‚½ãƒ¼ãƒˆã‚’é©ç”¨ã™ã‚‹é–¢æ•°
         */
        function applyRegionSort() {
            updateMapLink();
            showMessage('åœ°åŸŸã®é †åºã‚’é©ç”¨ã—ã¾ã—ãŸ', 'success');
        }

        /**
         * åœ°åŸŸé¸æŠã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
         * @param {Array} properties - ä¿å­˜æ¸ˆã¿ç‰©ä»¶é…åˆ—
         * @returns {string} åœ°åŸŸé¸æŠã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®HTML
         */
        function generateRegionSelectInterface(properties) {
            const groupedProperties = groupPropertiesByTown(properties);
            const townNames = Object.keys(groupedProperties).sort();

            return `
                <div class="region-select-container">
                    <div class="region-select-header">
                        ğŸ¯ è¡¨ç¤ºã™ã‚‹åœ°åŸŸã‚’é¸æŠ
                    </div>
                    <div class="region-select-description">
                        ãƒã‚§ãƒƒã‚¯ã—ãŸåœ°åŸŸã®ã¿ã§ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™
                    </div>
                    <div class="region-checkboxes">
                        ${townNames.map(townName => {
                const count = groupedProperties[townName].length;
                return `
                                <div class="region-checkbox-item">
                                    <input type="checkbox" id="region_${townName}" value="${townName}" 
                                           onchange="updateRegionSelection()" checked>
                                    <label for="region_${townName}">
                                        ${escapeHtml(townName)} (${count}ä»¶)
                                    </label>
                                </div>
                            `;
            }).join('')}
                    </div>
                    <div class="region-select-controls">
                        <button onclick="selectAllRegions()" class="button-secondary">ã™ã¹ã¦é¸æŠ</button>
                        <button onclick="unselectAllRegions()" class="button-secondary">ã™ã¹ã¦è§£é™¤</button>
                    </div>
                    <div id="regionSelectionMessage" class="region-selection-message"></div>
                </div>
            `;
        }

        /**
         * åœ°åŸŸé¸æŠã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        function updateRegionSelection() {
            const selectedRegions = getSelectedRegions();
            const messageDiv = document.getElementById('regionSelectionMessage');

            if (selectedRegions.length === 0) {
                messageDiv.innerHTML = '<div style="color: #dc3545; font-size: 14px; margin-top: 10px;">âš ï¸ æœ€ä½1ã¤ã®åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
            } else {
                messageDiv.innerHTML = `<div style="color: #28a745; font-size: 14px; margin-top: 10px;">âœ… ${selectedRegions.length}ã¤ã®åœ°åŸŸãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™</div>`;
            }

            updateMapLink();
        }

        /**
         * é¸æŠã•ã‚ŒãŸåœ°åŸŸåã‚’å–å¾—ã™ã‚‹é–¢æ•°
         * @returns {Array} é¸æŠã•ã‚ŒãŸåœ°åŸŸåã®é…åˆ—
         */
        function getSelectedRegions() {
            const checkboxes = document.querySelectorAll('.region-checkboxes input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                // åœ°åŸŸé¸æŠã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã€ã™ã¹ã¦ã®åœ°åŸŸã‚’è¿”ã™
                const groupedProperties = groupPropertiesByTown(savedProperties);
                return Object.keys(groupedProperties);
            }
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        /**
         * ã™ã¹ã¦ã®åœ°åŸŸã‚’é¸æŠã™ã‚‹é–¢æ•°
         */
        function selectAllRegions() {
            const checkboxes = document.querySelectorAll('.region-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateRegionSelection();
        }

        /**
         * ã™ã¹ã¦ã®åœ°åŸŸã®é¸æŠã‚’è§£é™¤ã™ã‚‹é–¢æ•°
         */
        function unselectAllRegions() {
            const checkboxes = document.querySelectorAll('.region-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateRegionSelection();
        }

        /**
         * æŒ‡å®šã•ã‚ŒãŸåœ°åŸŸã®ã¿ã§Googleãƒãƒƒãƒ—ãƒ«ãƒ¼ãƒˆã‚’é–‹ãé–¢æ•°
         * @param {string} townName - åœ°åŸŸå
         */
        function openRegionRoute(townName) {
            console.log('åœ°åŸŸãƒ«ãƒ¼ãƒˆä½œæˆé–‹å§‹:', townName);

            // æŒ‡å®šã•ã‚ŒãŸåœ°åŸŸã®ä¿å­˜æ¸ˆã¿ç‰©ä»¶ã‚’å–å¾—
            const regionProperties = savedProperties.filter(property => {
                const propertyTown = extractTownName(property.address);
                return propertyTown === townName;
            });

            if (regionProperties.length === 0) {
                showMessage(`${townName}ã«ä¿å­˜æ¸ˆã¿ç‰©ä»¶ãŒã‚ã‚Šã¾ã›ã‚“`, 'error');
                return;
            }

            if (regionProperties.length === 1) {
                // 1ä»¶ã®ã¿ã®å ´åˆã¯å€‹åˆ¥ãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ã‚’é–‹ã
                const mapLink = generateIndividualMapLink(regionProperties[0].address);
                window.open(mapLink, '_blank');
                showMessage(`${townName}ã®ç‰©ä»¶(1ä»¶)ã‚’Googleãƒãƒƒãƒ—ã§é–‹ãã¾ã—ãŸ`, 'success');
                return;
            }

            try {
                // ä½æ‰€ãƒªã‚¹ãƒˆã‚’ä½œæˆ
                const addresses = regionProperties.map(property => property.address).filter(Boolean);

                if (addresses.length === 0) {
                    showMessage(`${townName}ã®ç‰©ä»¶ã«æœ‰åŠ¹ãªä½æ‰€ãŒã‚ã‚Šã¾ã›ã‚“`, 'error');
                    return;
                }

                // å¤§å¡šé§è»Šå ´ã‚’æœ€çµ‚ç›®çš„åœ°ã«ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const useCustomDestination = getCustomDestinationEnabled();
                if (useCustomDestination) {
                    addresses.push(getCustomDestinationAddress());
                }

                // Googleãƒãƒƒãƒ—ã®çµŒè·¯URLã‚’ç”Ÿæˆ
                const origin = encodeURIComponent(addresses[0]);
                const destination = encodeURIComponent(addresses[addresses.length - 1]);

                let mapUrl = `https://www.google.com/maps/dir/${origin}`;

                // ä¸­é–“ã®çµŒç”±åœ°ã‚’è¿½åŠ 
                if (addresses.length > 2) {
                    const waypoints = addresses.slice(1, -1).map(addr => encodeURIComponent(addr)).join('/');
                    mapUrl += `/${waypoints}`;
                }

                mapUrl += `/${destination}`;

                // æœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                mapUrl += '?travelmode=driving&optimize=true';

                // ãƒãƒƒãƒ—ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                window.open(mapUrl, '_blank');

                const destinationInfo = useCustomDestination ? ' + å¤§å¡šé§è»Šå ´' : '';
                showMessage(`${townName}ã®ç‰©ä»¶(${regionProperties.length}ä»¶)${destinationInfo}ã§ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ`, 'success');

                console.log('åœ°åŸŸãƒ«ãƒ¼ãƒˆä½œæˆå®Œäº†:', {
                    townName,
                    propertiesCount: regionProperties.length,
                    addressesCount: addresses.length,
                    useCustomDestination,
                    mapUrl
                });

            } catch (error) {
                console.error('åœ°åŸŸãƒ«ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                showMessage(`${townName}ã®ãƒ«ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ`, 'error');
            }
        }

        /**
         * åœ°åŸŸã‚’ä¸Šã«ç§»å‹•ã™ã‚‹é–¢æ•°ï¼ˆã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ï¼‰
         */
        function moveRegionUp(event, townName) {
            event.stopPropagation();
            const container = document.getElementById('regionSortableContainer');
            if (!container) return;

            const regions = Array.from(container.children);
            const currentIndex = regions.findIndex(region =>
                region.getAttribute('data-town-name') === townName
            );

            if (currentIndex > 0) {
                const currentRegion = regions[currentIndex];
                const previousRegion = regions[currentIndex - 1];
                container.insertBefore(currentRegion, previousRegion);
                updateRegionMobileButtons();
                showMessage(`åœ°åŸŸã€Œ${townName}ã€ã‚’ä¸Šã«ç§»å‹•ã—ã¾ã—ãŸ`, 'success');
            }
        }

        /**
         * åœ°åŸŸã‚’ä¸‹ã«ç§»å‹•ã™ã‚‹é–¢æ•°ï¼ˆã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ï¼‰
         */
        function moveRegionDown(event, townName) {
            event.stopPropagation();
            const container = document.getElementById('regionSortableContainer');
            if (!container) return;

            const regions = Array.from(container.children);
            const currentIndex = regions.findIndex(region =>
                region.getAttribute('data-town-name') === townName
            );

            if (currentIndex < regions.length - 1) {
                const currentRegion = regions[currentIndex];
                const nextRegion = regions[currentIndex + 1];
                container.insertBefore(nextRegion, currentRegion);
                updateRegionMobileButtons();
                showMessage(`åœ°åŸŸã€Œ${townName}ã€ã‚’ä¸‹ã«ç§»å‹•ã—ã¾ã—ãŸ`, 'success');
            }
        }

        /**
         * åœ°åŸŸãƒ¢ãƒã‚¤ãƒ«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        function updateRegionMobileButtons() {
            const container = document.getElementById('regionSortableContainer');
            if (!container) return;

            const regions = Array.from(container.children);
            regions.forEach((region, index) => {
                const upBtn = region.querySelector('.mobile-btn:first-child');
                const downBtn = region.querySelector('.mobile-btn:last-child');

                if (upBtn) {
                    upBtn.disabled = index === 0;
                }
                if (downBtn) {
                    downBtn.disabled = index === regions.length - 1;
                }
            });
        }

        /**
         * åœ°åŸŸåˆ¥ã‚½ãƒ¼ãƒˆã®é †åºã‚’å–å¾—ã™ã‚‹é–¢æ•°
         * @returns {Array} ä¸¦ã³æ›¿ãˆã‚‰ã‚ŒãŸç‰©ä»¶é…åˆ—
         */
        function getRegionSortOrder() {
            const container = document.getElementById('regionSortableContainer');
            if (!container) return null;

            const regionElements = Array.from(container.children);
            const sortedProperties = [];

            regionElements.forEach(regionElement => {
                const townName = regionElement.getAttribute('data-town-name');
                const townProperties = savedProperties.filter(property => {
                    const propertyTown = extractTownName(property.address);
                    return propertyTown === townName;
                });
                sortedProperties.push(...townProperties);
            });

            return sortedProperties;
        }

        /**
         * åœ°åŸŸãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
         */
        function initializeRegionDragAndDrop() {
            console.log('åœ°åŸŸãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–ä¸­...');

            const container = document.getElementById('regionSortableContainer');
            if (!container) {
                console.log('regionSortableContainerè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const regionGroups = container.querySelectorAll('.region-group-sortable');
            let draggedRegion = null;

            regionGroups.forEach(regionGroup => {
                regionGroup.draggable = true;

                // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                regionGroup.addEventListener('dragstart', function (e) {
                    const townName = this.getAttribute('data-town-name');
                    console.log('åœ°åŸŸãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹:', townName);
                    draggedRegion = this;
                    this.classList.add('dragging');

                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.outerHTML);
                });

                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
                regionGroup.addEventListener('dragend', function (e) {
                    console.log('åœ°åŸŸãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†');
                    this.classList.remove('dragging');

                    // å…¨ã¦ã®å¢ƒç•Œç·šã‚’å‰Šé™¤
                    regionGroups.forEach(group => {
                        group.style.borderTop = '';
                        group.style.borderBottom = '';
                    });

                    draggedRegion = null;
                });

                // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
                regionGroup.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    if (draggedRegion && draggedRegion !== this) {
                        e.dataTransfer.dropEffect = 'move';

                        // å…¨ã¦ã®å¢ƒç•Œç·šã‚’ã‚¯ãƒªã‚¢
                        regionGroups.forEach(group => {
                            group.style.borderTop = '';
                            group.style.borderBottom = '';
                        });

                        // ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®ã‚’æ±ºå®š
                        const rect = this.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;

                        if (e.clientY < midpoint) {
                            // ä¸Šã«æŒ¿å…¥
                            this.style.borderTop = '4px solid #007bff';
                        } else {
                            // ä¸‹ã«æŒ¿å…¥
                            this.style.borderBottom = '4px solid #007bff';
                        }
                    }
                });

                // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
                regionGroup.addEventListener('dragleave', function (e) {
                    const rect = this.getBoundingClientRect();
                    if (e.clientX < rect.left || e.clientX > rect.right ||
                        e.clientY < rect.top || e.clientY > rect.bottom) {
                        this.style.borderTop = '';
                        this.style.borderBottom = '';
                    }
                });

                // ãƒ‰ãƒ­ãƒƒãƒ—
                regionGroup.addEventListener('drop', function (e) {
                    e.preventDefault();
                    this.style.borderTop = '';
                    this.style.borderBottom = '';

                    if (draggedRegion && draggedRegion !== this) {
                        const rect = this.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;

                        const draggedTownName = draggedRegion.getAttribute('data-town-name');
                        const targetTownName = this.getAttribute('data-town-name');

                        if (e.clientY < midpoint) {
                            // ä¸Šã«æŒ¿å…¥
                            this.parentNode.insertBefore(draggedRegion, this);
                            console.log(`åœ°åŸŸã€Œ${draggedTownName}ã€ã‚’ã€Œ${targetTownName}ã€ã®ä¸Šã«ç§»å‹•`);
                        } else {
                            // ä¸‹ã«æŒ¿å…¥
                            this.parentNode.insertBefore(draggedRegion, this.nextSibling);
                            console.log(`åœ°åŸŸã€Œ${draggedTownName}ã€ã‚’ã€Œ${targetTownName}ã€ã®ä¸‹ã«ç§»å‹•`);
                        }

                        showMessage(`åœ°åŸŸã€Œ${draggedTownName}ã€ã®é †åºã‚’å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');

                        // ãƒ¢ãƒã‚¤ãƒ«ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                        if (isTouchDevice()) {
                            updateRegionMobileButtons();
                        }
                    }
                });
            });

            console.log(`${regionGroups.length}å€‹ã®åœ°åŸŸã‚°ãƒ«ãƒ¼ãƒ—ã§ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—åˆæœŸåŒ–å®Œäº†`);
        }

        /**
         * ç”ºåã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
         * åœ°åŸŸã”ã¨ã®ç§»å‹•ã‚’å¯èƒ½ã«ã™ã‚‹
         */
        function initializeTownGroupDragAndDrop() {
            console.log('ç”ºåã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–ä¸­...');

            const townGroups = document.querySelectorAll('.town-group');
            let draggedTownGroup = null;

            townGroups.forEach((townGroup, index) => {
                townGroup.draggable = true;
                townGroup.setAttribute('data-town-index', index);

                // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                townGroup.addEventListener('dragstart', function (e) {
                    const townName = this.querySelector('.town-header').textContent.trim();
                    console.log('ç”ºåã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹:', townName);
                    draggedTownGroup = this;
                    this.classList.add('dragging');

                    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.outerHTML);
                });

                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
                townGroup.addEventListener('dragend', function (e) {
                    console.log('ç”ºåã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†');
                    this.classList.remove('dragging');

                    // å…¨ã¦ã®å¢ƒç•Œç·šã‚’å‰Šé™¤
                    document.querySelectorAll('.town-group').forEach(group => {
                        group.style.borderTop = '';
                        group.style.borderBottom = '';
                    });

                    draggedTownGroup = null;
                });

                // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
                townGroup.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    if (draggedTownGroup && draggedTownGroup !== this) {
                        e.dataTransfer.dropEffect = 'move';

                        // å…¨ã¦ã®å¢ƒç•Œç·šã‚’ã‚¯ãƒªã‚¢
                        document.querySelectorAll('.town-group').forEach(group => {
                            group.style.borderTop = '';
                            group.style.borderBottom = '';
                        });

                        // ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®ã‚’æ±ºå®š
                        const rect = this.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;

                        if (e.clientY < midpoint) {
                            // ä¸Šã«æŒ¿å…¥
                            this.style.borderTop = '4px solid #007bff';
                        } else {
                            // ä¸‹ã«æŒ¿å…¥
                            this.style.borderBottom = '4px solid #007bff';
                        }
                    }
                });

                // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
                townGroup.addEventListener('dragleave', function (e) {
                    // ãƒã‚¦ã‚¹ãŒå®Œå…¨ã«è¦ç´ ã‹ã‚‰é›¢ã‚ŒãŸå ´åˆã®ã¿ãƒœãƒ¼ãƒ€ãƒ¼ã‚’å‰Šé™¤
                    const rect = this.getBoundingClientRect();
                    if (e.clientX < rect.left || e.clientX > rect.right ||
                        e.clientY < rect.top || e.clientY > rect.bottom) {
                        this.style.borderTop = '';
                        this.style.borderBottom = '';
                    }
                });

                // ãƒ‰ãƒ­ãƒƒãƒ—
                townGroup.addEventListener('drop', function (e) {
                    e.preventDefault();
                    this.style.borderTop = '';
                    this.style.borderBottom = '';

                    if (draggedTownGroup && draggedTownGroup !== this) {
                        const rect = this.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;

                        const draggedTownName = draggedTownGroup.querySelector('.town-header').textContent.trim();
                        const targetTownName = this.querySelector('.town-header').textContent.trim();

                        if (e.clientY < midpoint) {
                            // ä¸Šã«æŒ¿å…¥
                            this.parentNode.insertBefore(draggedTownGroup, this);
                            console.log(`åœ°åŸŸã€Œ${draggedTownName}ã€ã‚’ã€Œ${targetTownName}ã€ã®ä¸Šã«ç§»å‹•`);
                        } else {
                            // ä¸‹ã«æŒ¿å…¥
                            this.parentNode.insertBefore(draggedTownGroup, this.nextSibling);
                            console.log(`åœ°åŸŸã€Œ${draggedTownName}ã€ã‚’ã€Œ${targetTownName}ã€ã®ä¸‹ã«ç§»å‹•`);
                        }

                        showMessage(`åœ°åŸŸã€Œ${draggedTownName}ã€ã®é †åºã‚’å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');

                        // ç§»å‹•å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†åˆæœŸåŒ–
                        setTimeout(() => {
                            initializeTownGroupDragAndDrop();
                        }, 100);
                    }
                });
            });

            console.log(`${townGroups.length}å€‹ã®ç”ºåã‚°ãƒ«ãƒ¼ãƒ—ã§ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—åˆæœŸåŒ–å®Œäº†`);
        }

        /**
         * ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
         */
        function initializeDragAndDrop() {
            const sortableList = document.getElementById('sortableList');
            if (!sortableList) {
                console.log('sortableListè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            console.log('ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–ä¸­...');
            let draggedElement = null;

            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
            const newSortableList = sortableList.cloneNode(true);
            sortableList.parentNode.replaceChild(newSortableList, sortableList);

            // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
            newSortableList.addEventListener('dragstart', function (e) {
                console.log('ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹:', e.target);
                if (e.target.classList.contains('sortable-item')) {
                    draggedElement = e.target;
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', e.target.outerHTML);
                }
            });

            // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
            newSortableList.addEventListener('dragend', function (e) {
                console.log('ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†:', e.target);
                if (e.target.classList.contains('sortable-item')) {
                    e.target.classList.remove('dragging');
                    draggedElement = null;
                    // ç•ªå·ã‚’æ›´æ–°
                    updateItemNumbers();
                }
            });

            // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
            newSortableList.addEventListener('dragover', function (e) {
                e.preventDefault();
                if (draggedElement) {
                    const afterElement = getDragAfterElement(newSortableList, e.clientY);
                    if (afterElement == null) {
                        newSortableList.appendChild(draggedElement);
                    } else {
                        newSortableList.insertBefore(draggedElement, afterElement);
                    }
                }
            });

            // ãƒ‰ãƒ­ãƒƒãƒ—
            newSortableList.addEventListener('drop', function (e) {
                e.preventDefault();
                console.log('ãƒ‰ãƒ­ãƒƒãƒ—å®Œäº†');
                updateItemNumbers();
            });

            // å„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«è¨­å®š
            newSortableList.querySelectorAll('.sortable-item').forEach((item, index) => {
                item.draggable = true;

                // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                const handle = item.querySelector('.drag-handle');
                if (handle) {
                    handle.addEventListener('mousedown', function (e) {
                        console.log('ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‚¯ãƒªãƒƒã‚¯');
                        item.style.cursor = 'grabbing';
                    });

                    handle.addEventListener('mouseup', function (e) {
                        item.style.cursor = 'grab';
                    });
                }
            });

            console.log('ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—åˆæœŸåŒ–å®Œäº†');
        }

        /**
         * ã‚¢ã‚¤ãƒ†ãƒ ã®ç•ªå·ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        function updateItemNumbers() {
            const sortableList = document.getElementById('sortableList');
            if (!sortableList) return;

            sortableList.querySelectorAll('.sortable-item').forEach((item, index) => {
                const strongElement = item.querySelector('strong');
                if (strongElement) {
                    const text = strongElement.textContent;
                    const newText = text.replace(/^\d+\./, `${index + 1}.`);
                    strongElement.textContent = newText;
                }
            });
        }

        /**
 * ã‚¿ãƒƒãƒã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
 */
        function initializeTouchInterface() {
            console.log('ã‚¿ãƒƒãƒã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ä¸­...');
            updateMobileButtons();

            // ã‚¿ãƒƒãƒã«ã‚ˆã‚‹é•·æŠ¼ã—ã§ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—é¢¨ã®æ“ä½œã‚‚å¯èƒ½ã«ã™ã‚‹
            const sortableList = document.getElementById('sortableList');
            if (sortableList) {
                let touchStartY = 0;
                let isDragging = false;
                let draggedElement = null;

                sortableList.addEventListener('touchstart', function (e) {
                    const item = e.target.closest('.sortable-item');
                    if (item) {
                        touchStartY = e.touches[0].clientY;

                        // é•·æŠ¼ã—æ¤œå‡º
                        setTimeout(() => {
                            if (Math.abs(e.touches[0].clientY - touchStartY) < 10) {
                                isDragging = true;
                                draggedElement = item;
                                item.style.opacity = '0.7';
                                item.style.transform = 'scale(1.05)';
                                showMessage('ãƒ‰ãƒ©ãƒƒã‚°ä¸­... æŒ‡ã‚’é›¢ã—ã¦é…ç½®ã—ã¦ãã ã•ã„', 'loading');
                            }
                        }, 500); // 500msé•·æŠ¼ã—
                    }
                });

                sortableList.addEventListener('touchmove', function (e) {
                    if (isDragging && draggedElement) {
                        e.preventDefault();
                        const touch = e.touches[0];
                        const afterElement = getDragAfterElement(sortableList, touch.clientY);

                        if (afterElement == null) {
                            sortableList.appendChild(draggedElement);
                        } else {
                            sortableList.insertBefore(draggedElement, afterElement);
                        }
                    }
                });

                sortableList.addEventListener('touchend', function (e) {
                    if (isDragging && draggedElement) {
                        draggedElement.style.opacity = '';
                        draggedElement.style.transform = '';
                        updateItemNumbers();
                        updateMobileButtons();
                        showMessage('ä½ç½®ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');

                        isDragging = false;
                        draggedElement = null;
                    }
                });
            }

            console.log('ã‚¿ãƒƒãƒã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åˆæœŸåŒ–å®Œäº†');
        }

        /**
         * ãƒ‰ãƒ©ãƒƒã‚°ä½ç½®ã«åŸºã¥ã„ã¦æŒ¿å…¥ä½ç½®ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
         */
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.sortable-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        /**
         * å¤§å¡šé§è»Šå ´ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
         * ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã€
         * ç¾åœ¨ã®ä¸¦ã³æ›¿ãˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å¿œã˜ã¦æœ€é©åŒ–å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹
         */
        function handleCustomDestinationChange() {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            const checkbox = document.getElementById('useCustomDestination');
            localStorage.setItem('useCustomDestination', checkbox.checked);

            // ç¾åœ¨ã®ä¸¦ã³æ›¿ãˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
            const currentOptimization = getSelectedOptimization();

            // ãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ã‚’æ›´æ–°ï¼ˆè·é›¢æœ€é©åŒ–ã®å ´åˆã¯å¤§å¡šé§è»Šå ´ã‚’è€ƒæ…®ã—ãŸå†è¨ˆç®—ãŒè¡Œã‚ã‚Œã‚‹ï¼‰
            updateMapLink();

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const message = checkbox.checked ?
                'å¤§å¡šé§è»Šå ´ã‚’æœ€çµ‚ç›®çš„åœ°ã«è¨­å®šã—ã¾ã—ãŸ' :
                'å¤§å¡šé§è»Šå ´ã‚’æœ€çµ‚ç›®çš„åœ°ã‹ã‚‰å¤–ã—ã¾ã—ãŸ';
            showMessage(message, 'success');

            // è·é›¢æœ€é©åŒ–ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (currentOptimization === 'distance_optimized') {
                const additionalMessage = checkbox.checked ?
                    'ãƒ«ãƒ¼ãƒˆãŒå¤§å¡šé§è»Šå ´ã‚’è€ƒæ…®ã—ã¦å†æœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ' :
                    'ãƒ«ãƒ¼ãƒˆãŒç‰©ä»¶ã®ã¿ã§å†æœ€é©åŒ–ã•ã‚Œã¾ã—ãŸ';
                setTimeout(() => showMessage(additionalMessage, 'loading'), 1000);
            }
        }

        /**
         * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
         * XSSæ”»æ’ƒã‚’é˜²ããŸã‚ã€HTMLã®ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
         * @param {string} text - ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
         * @returns {string} ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * å€‹åˆ¥ã®ä½æ‰€ã®Googleãƒãƒƒãƒ—ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
         * @param {string} address - ä½æ‰€
         * @returns {string} Googleãƒãƒƒãƒ—ã®URL
         */
        function generateIndividualMapLink(address) {
            if (!address) return '#';
            const encodedAddress = encodeURIComponent(address);
            return `https://www.google.com/maps/search/${encodedAddress}`;
        }

        // Enterã‚­ãƒ¼ã§ã®æ¤œç´¢æ©Ÿèƒ½ã¨åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        searchProperties();
                    }
                });
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¤§å¡šé§è»Šå ´ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹çŠ¶æ…‹ã‚’å¾©å…ƒ
            const checkbox = document.getElementById('useCustomDestination');
            if (checkbox) {
                const saved = localStorage.getItem('useCustomDestination');
                if (saved === 'true') {
                    checkbox.checked = true;
                } else if (saved === 'false') {
                    checkbox.checked = false;
                }
                // savedãŒnullã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆuncheckedï¼‰ã®ã¾ã¾
            }
        });
    </script>
</body>

</html>